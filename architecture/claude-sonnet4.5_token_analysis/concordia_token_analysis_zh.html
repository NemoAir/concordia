<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concordia Token æµåŠ¨ä¸å³°å€¼åˆ†æ</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            line-height: 1.8;
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #3498db;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }
        h2 {
            color: #34495e;
            border-left: 5px solid #3498db;
            padding-left: 15px;
            margin-top: 40px;
            background-color: #ecf0f1;
            padding: 10px 10px 10px 15px;
        }
        h3 {
            color: #555;
            margin-top: 25px;
            border-bottom: 2px solid #95a5a6;
            padding-bottom: 8px;
        }
        .token-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .token-table th {
            background-color: #3498db;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }
        .token-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #ddd;
        }
        .token-table tr:hover {
            background-color: #f8f9fa;
        }
        .code-ref {
            font-family: 'Courier New', monospace;
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
            color: #e74c3c;
        }
        .highlight-box {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin: 20px 0;
        }
        .peak-box {
            background-color: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin: 20px 0;
        }
        .calculation-box {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        .formula {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
        }
        .section {
            background-color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .flow-diagram {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
        }
        .number-large {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
        }
        ul, ol {
            margin: 15px 0;
        }
        li {
            margin: 8px 0;
        }
        .warning {
            color: #dc3545;
            font-weight: bold;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸ”¥ Concordia Token æµåŠ¨ä¸å³°å€¼åˆ†æ</h1>

    <div class="highlight-box">
        <h3>ğŸ“Š æ ¸å¿ƒå‘ç°æ‘˜è¦</h3>
        <ul>
            <li><strong>å•æ¬¡Agent.act()å³°å€¼ï¼š</strong> <span class="number-large">8,000 - 12,000</span> tokens (input + output)</li>
            <li><strong>å•æ¬¡GM event resolutionå³°å€¼ï¼š</strong> <span class="number-large">15,000 - 25,000</span> tokens</li>
            <li><strong>å®Œæ•´æ¸¸æˆå¾ªç¯å•æ­¥å³°å€¼ï¼š</strong> <span class="number-large">25,000 - 40,000</span> tokens</li>
            <li><strong>å¤šAgentå¹¶è¡Œæ—¶å³°å€¼ï¼š</strong> <span class="number-large">å¯è¾¾ 100,000+</span> tokens (5+ agents)</li>
        </ul>
    </div>

    <div class="section">
        <h2>1. Tokené…ç½®åŸºå‡†å€¼</h2>

        <h3>1.1 ç³»ç»Ÿé»˜è®¤é…ç½®</h3>
        <table class="token-table">
            <tr>
                <th>é…ç½®é¡¹</th>
                <th>æ•°å€¼</th>
                <th>ä»£ç ä½ç½®</th>
            </tr>
            <tr>
                <td><strong>LanguageModel.DEFAULT_MAX_TOKENS</strong></td>
                <td>5000 tokens</td>
                <td><span class="code-ref">language_model/language_model.py:27</span></td>
            </tr>
            <tr>
                <td><strong>InteractiveDocument.DEFAULT_MAX_TOKENS</strong></td>
                <td>50 tokens</td>
                <td><span class="code-ref">document/interactive_document.py:28</span></td>
            </tr>
            <tr>
                <td><strong>InteractiveDocument.DEFAULT_MAX_CHARACTERS</strong></td>
                <td>200 characters</td>
                <td><span class="code-ref">document/interactive_document.py:27</span></td>
            </tr>
        </table>

        <div class="highlight-box">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>è™½ç„¶InteractiveDocumenté»˜è®¤åªæœ‰50 tokensï¼Œä½†å®é™…ä½¿ç”¨ä¸­å‡ ä¹æ‰€æœ‰ç»„ä»¶éƒ½ä¼šè¦†ç›–è¿™ä¸ªå€¼ï¼Œä½¿ç”¨æ›´å¤§çš„max_tokensï¼ˆé€šå¸¸æ˜¯750-3000ï¼‰ã€‚
        </div>
    </div>

    <div class="section">
        <h2>2. Agentç»„ä»¶Tokenä½¿ç”¨è¯¦æƒ…</h2>

        <h3>2.1 å…¸å‹Basic Agentçš„ç»„ä»¶é…ç½®</h3>
        <p>å‚è€ƒæ–‡ä»¶ï¼š<span class="code-ref">prefabs/entity/basic.py</span></p>

        <table class="token-table">
            <thead>
                <tr>
                    <th>ç»„ä»¶åç§°</th>
                    <th>LLMè°ƒç”¨æ¬¡æ•°</th>
                    <th>max_tokensé…ç½®</th>
                    <th>Memoryæ£€ç´¢é‡</th>
                    <th>ä¼°ç®—Input Tokens</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Instructions</strong></td>
                    <td>0</td>
                    <td>N/A</td>
                    <td>0</td>
                    <td>~200 (å›ºå®šæ–‡æœ¬)</td>
                    <td><span class="code-ref">components/agent/instructions.py</span></td>
                </tr>
                <tr>
                    <td><strong>LastNObservations</strong></td>
                    <td>0</td>
                    <td>N/A</td>
                    <td>100æ¡è§‚å¯Ÿ</td>
                    <td>~3,000-5,000</td>
                    <td><span class="code-ref">prefabs/entity/basic.py:73-74</span></td>
                </tr>
                <tr>
                    <td><strong>AllSimilarMemories</strong></td>
                    <td>1 (summary)</td>
                    <td>750</td>
                    <td>10æ¡è®°å¿†</td>
                    <td>~1,500-2,000 (input)<br>~750 (output)</td>
                    <td><span class="code-ref">components/agent/all_similar_memories.py:82</span></td>
                </tr>
                <tr>
                    <td><strong>SituationPerception</strong></td>
                    <td>1</td>
                    <td>1000</td>
                    <td>25æ¡è®°å¿†</td>
                    <td>~3,000-4,000 (input)<br>~200-400 (output)</td>
                    <td><span class="code-ref">components/agent/question_of_recent_memories.py:147</span></td>
                </tr>
                <tr>
                    <td><strong>SelfPerception</strong></td>
                    <td>1</td>
                    <td>1000</td>
                    <td>25æ¡è®°å¿†</td>
                    <td>~3,000-4,000 (input)<br>~200-400 (output)</td>
                    <td><span class="code-ref">components/agent/question_of_recent_memories.py:147</span></td>
                </tr>
                <tr>
                    <td><strong>PersonBySituation</strong></td>
                    <td>1</td>
                    <td>1000</td>
                    <td>25æ¡è®°å¿†</td>
                    <td>~3,500-4,500 (input)<br>~200-400 (output)</td>
                    <td><span class="code-ref">components/agent/question_of_recent_memories.py:147</span></td>
                </tr>
                <tr>
                    <td><strong>ConcatActComponent</strong></td>
                    <td>1 (final action)</td>
                    <td>2200</td>
                    <td>0 (ä½¿ç”¨æ±‡æ€»çš„context)</td>
                    <td>~6,000-8,000 (input)<br>~50-200 (output)</td>
                    <td><span class="code-ref">components/agent/concat_act_component.py:118</span></td>
                </tr>
            </tbody>
        </table>

        <h3>2.2 Agent.act() å•æ¬¡è°ƒç”¨TokenæµåŠ¨</h3>

        <div class="flow-diagram">Agent.act() TokenæµåŠ¨æ—¶åºå›¾ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Phase: PRE_ACT                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. AllSimilarMemories.pre_act()                               â”‚
â”‚     â”œâ”€ Input: ç»„ä»¶çŠ¶æ€ (~1,500 tokens)                          â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: summaryç”Ÿæˆ (max_tokens=750)                    â”‚
â”‚     â”œâ”€ Memoryæ£€ç´¢: 10æ¡ (~500 tokens)                           â”‚
â”‚     â””â”€ Output: æ£€ç´¢åˆ°çš„è®°å¿† (~500 tokens)                        â”‚
â”‚                                                                 â”‚
â”‚  2. SituationPerception.pre_act()                              â”‚
â”‚     â”œâ”€ Input: 25æ¡recent memories (~3,000 tokens)              â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: å›ç­”æƒ…å¢ƒé—®é¢˜ (max_tokens=1000)                  â”‚
â”‚     â””â”€ Output: æƒ…å¢ƒæè¿° (~200-400 tokens)                       â”‚
â”‚                                                                 â”‚
â”‚  3. SelfPerception.pre_act()                                   â”‚
â”‚     â”œâ”€ Input: 25æ¡recent memories (~3,000 tokens)              â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: å›ç­”è‡ªæˆ‘è®¤çŸ¥é—®é¢˜ (max_tokens=1000)              â”‚
â”‚     â””â”€ Output: è‡ªæˆ‘æè¿° (~200-400 tokens)                       â”‚
â”‚                                                                 â”‚
â”‚  4. PersonBySituation.pre_act()                                â”‚
â”‚     â”œâ”€ Input: 25æ¡memories + 2ä¸ªç»„ä»¶è¾“å‡º (~3,500 tokens)        â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: æ¨ç†è¡Œä¸ºå€¾å‘ (max_tokens=1000)                  â”‚
â”‚     â””â”€ Output: è¡Œä¸ºæ¨ç† (~200-400 tokens)                       â”‚
â”‚                                                                 â”‚
â”‚  PRE_ACTé˜¶æ®µå°è®¡:                                               â”‚
â”‚  â”œâ”€ LLMè°ƒç”¨æ¬¡æ•°: 4æ¬¡                                            â”‚
â”‚  â”œâ”€ Input Tokens: ~11,000 - 14,000                             â”‚
â”‚  â””â”€ Output Tokens: ~1,850 - 2,550                              â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Phase: ACT (ConcatActComponent)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  5. ConcatActComponent.get_action_attempt()                    â”‚
â”‚     â”œâ”€ Input: æ±‡æ€»æ‰€æœ‰ç»„ä»¶context (~6,000-8,000 tokens)         â”‚
â”‚     â”‚   â”œâ”€ Instructions: ~200                                  â”‚
â”‚     â”‚   â”œâ”€ LastNObservations: ~3,000-5,000                     â”‚
â”‚     â”‚   â”œâ”€ AllSimilarMemories: ~500                            â”‚
â”‚     â”‚   â”œâ”€ SituationPerception: ~200-400                       â”‚
â”‚     â”‚   â”œâ”€ SelfPerception: ~200-400                            â”‚
â”‚     â”‚   â””â”€ PersonBySituation: ~200-400                         â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: ç”Ÿæˆæœ€ç»ˆåŠ¨ä½œ (max_tokens=2200)                  â”‚
â”‚     â””â”€ Output: åŠ¨ä½œå­—ç¬¦ä¸² (~50-200 tokens)                      â”‚
â”‚                                                                 â”‚
â”‚  ACTé˜¶æ®µå°è®¡:                                                   â”‚
â”‚  â”œâ”€ LLMè°ƒç”¨æ¬¡æ•°: 1æ¬¡                                            â”‚
â”‚  â”œâ”€ Input Tokens: ~6,000 - 8,000                               â”‚
â”‚  â””â”€ Output Tokens: ~50 - 200                                   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<strong>å•æ¬¡Agent.act()æ€»è®¡ï¼š</strong>
â”œâ”€ æ€»LLMè°ƒç”¨æ¬¡æ•°: 5æ¬¡
â”œâ”€ æ€»Input Tokens: ~17,000 - 22,000
â”œâ”€ æ€»Output Tokens: ~1,900 - 2,750
â””â”€ <span class="warning">å³°å€¼Tokenæ€»é‡: ~19,000 - 25,000 tokens</span>
        </div>

        <div class="peak-box">
            <h4>ğŸ”¥ Agent Tokenå³°å€¼å½±å“å› ç´ </h4>
            <ul>
                <li><strong>è§‚å¯Ÿå†å²é•¿åº¦ï¼š</strong>LastNObservationsé…ç½®ä¸º100æ¡ï¼Œæ¯æ¡è§‚å¯Ÿçº¦30-50 tokensï¼Œå…±3,000-5,000 tokens</li>
                <li><strong>Memoryæ£€ç´¢æ•°é‡ï¼š</strong>QuestionOfRecentMemoriesé»˜è®¤æ£€ç´¢25æ¡ï¼Œæ¯æ¡çº¦100-150 tokens</li>
                <li><strong>ç»„ä»¶æ•°é‡ï¼š</strong>æ›´å¤šreflectionç»„ä»¶ä¼šå¢åŠ PRE_ACTé˜¶æ®µçš„LLMè°ƒç”¨æ¬¡æ•°</li>
                <li><strong>å¹¶è¡Œå¤„ç†ï¼š</strong>Parallel engineä¸‹å¤šä¸ªAgentåŒæ—¶act()ä¼šå¯¼è‡´tokenæ•°å€å¢</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>3. Game Masterç»„ä»¶Tokenä½¿ç”¨è¯¦æƒ…</h2>

        <h3>3.1 å…¸å‹Generic GMçš„ç»„ä»¶é…ç½®</h3>
        <p>å‚è€ƒæ–‡ä»¶ï¼š<span class="code-ref">prefabs/game_master/generic.py</span></p>

        <table class="token-table">
            <thead>
                <tr>
                    <th>ç»„ä»¶åç§°</th>
                    <th>è§¦å‘æ—¶æœº</th>
                    <th>LLMè°ƒç”¨</th>
                    <th>max_tokens</th>
                    <th>ä¼°ç®—Tokenæ¶ˆè€—</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>LastNObservations</strong></td>
                    <td>æ¯æ¬¡act</td>
                    <td>0</td>
                    <td>N/A</td>
                    <td>~10,000-15,000 (1000æ¡å†å²)</td>
                    <td><span class="code-ref">generic.py:119-121</span></td>
                </tr>
                <tr>
                    <td><strong>DisplayEvents</strong></td>
                    <td>æ¯æ¬¡act</td>
                    <td>0</td>
                    <td>N/A</td>
                    <td>~5,000-8,000</td>
                    <td><span class="code-ref">components/game_master/event_resolution.py</span></td>
                </tr>
                <tr>
                    <td><strong>AllSimilarMemories</strong></td>
                    <td>æ¯æ¬¡act</td>
                    <td>1</td>
                    <td>750</td>
                    <td>Input: ~2,000<br>Output: ~750</td>
                    <td><span class="code-ref">generic.py:131-139</span></td>
                </tr>
                <tr>
                    <td><strong>MakeObservation</strong></td>
                    <td>MAKE_OBSERVATION</td>
                    <td>æ¯ç©å®¶1æ¬¡</td>
                    <td>1200</td>
                    <td>Input: ~8,000/ç©å®¶<br>Output: ~200-400/ç©å®¶</td>
                    <td><span class="code-ref">components/game_master/make_observation.py:166-173</span></td>
                </tr>
                <tr>
                    <td><strong>NextActing</strong></td>
                    <td>NEXT_ACTING</td>
                    <td>1</td>
                    <td>é»˜è®¤5000</td>
                    <td>Input: ~10,000<br>Output: ~50</td>
                    <td><span class="code-ref">components/game_master/next_acting.py</span></td>
                </tr>
                <tr>
                    <td><strong>NextActionSpec</strong></td>
                    <td>NEXT_ACTION_SPEC</td>
                    <td>1</td>
                    <td>é»˜è®¤5000</td>
                    <td>Input: ~10,000<br>Output: ~100</td>
                    <td><span class="code-ref">components/game_master/next_acting.py</span></td>
                </tr>
                <tr>
                    <td><strong>EventResolution</strong></td>
                    <td>RESOLVE</td>
                    <td>3-6æ¬¡ (ThoughtChains)</td>
                    <td>1200-3000/é“¾</td>
                    <td>Input: ~20,000-30,000<br>Output: ~3,000-5,000</td>
                    <td><span class="code-ref">components/game_master/event_resolution.py</span></td>
                </tr>
            </tbody>
        </table>

        <h3>3.2 EventResolution ThoughtChains Tokenè¯¦è§£</h3>
        <p>EventResolutionæ˜¯GMæœ€è€—tokençš„ç»„ä»¶ï¼Œå› ä¸ºå®ƒä½¿ç”¨å¤šæ­¥ThoughtChainsè¿›è¡Œäº‹ä»¶æ¨ç†ã€‚</p>

        <div class="flow-diagram">EventResolution ThoughtChainsæµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ThoughtChainæ­¥éª¤åºåˆ—ï¼ˆgeneric.pyé»˜è®¤é…ç½®ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Step 1: maybe_inject_narrative_push                           â”‚
â”‚     â”œâ”€ åŠŸèƒ½: æ£€æŸ¥æ˜¯å¦éœ€è¦narrativeå¹²é¢„                          â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: 0-1æ¬¡ (æ¡ä»¶è§¦å‘)                                â”‚
â”‚     â””â”€ Token: ~0-2,000                                         â”‚
â”‚                                                                 â”‚
â”‚  Step 2: AccountForAgencyOfOthers                              â”‚
â”‚     â”œâ”€ åŠŸèƒ½: è€ƒè™‘å…¶ä»–ç©å®¶çš„ä¸»åŠ¨æ€§                               â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: æ¯ä¸ªinactive player 1æ¬¡                        â”‚
â”‚     â”œâ”€ max_tokens: 1500/ç©å®¶ (thought_chains.py:344-372)       â”‚
â”‚     â””â”€ Token: ~(N-1) Ã— 3,000 (input+output)                   â”‚
â”‚        â””â”€ N=ç©å®¶æ•°ï¼Œå‡è®¾4ç©å®¶ â†’ ~9,000 tokens                  â”‚
â”‚                                                                 â”‚
â”‚  Step 3: result_to_who_what_where                              â”‚
â”‚     â”œâ”€ åŠŸèƒ½: æå–äº‹ä»¶çš„who/what/where                          â”‚
â”‚     â”œâ”€ LLMè°ƒç”¨: 1æ¬¡                                            â”‚
â”‚     â”œâ”€ max_tokens: 1200 (thought_chains.py:173-176)            â”‚
â”‚     â””â”€ Token: Input ~5,000 + Output ~200 = ~5,200             â”‚
â”‚                                                                 â”‚
â”‚  (å¯é€‰) Extra Steps (ç”¨æˆ·å¯é…ç½®):                               â”‚
â”‚     â”œâ”€ result_to_effect: max_tokens=1200                       â”‚
â”‚     â”œâ”€ result_to_causal_statement: max_tokens=1500             â”‚
â”‚     â”œâ”€ attempt_to_result: max_tokens=2500-3000                 â”‚
â”‚     â””â”€ æ¯å¢åŠ ä¸€æ­¥: ~3,000-5,000 tokens                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

<strong>å•æ¬¡EventResolution Tokenè®¡ç®—ï¼ˆ4ç©å®¶åœºæ™¯ï¼‰ï¼š</strong>

åŸºç¡€é…ç½®ï¼ˆ3æ­¥ï¼‰ï¼š
â”œâ”€ Contextå‡†å¤‡: ~10,000 tokens (GMæ‰€æœ‰ç»„ä»¶çš„context)
â”œâ”€ Step 1 (narrative): ~0-2,000
â”œâ”€ Step 2 (agency): ~9,000 (3ä¸ªinactive players)
â”œâ”€ Step 3 (who_what_where): ~5,200
â””â”€ <span class="warning">æ€»è®¡: ~24,000 - 26,000 tokens</span>

å¦‚æœæ·»åŠ é¢å¤–æ­¥éª¤ï¼ˆå¦‚result_to_effect, causal_statementï¼‰ï¼š
â””â”€ <span class="warning">æ€»è®¡å¯è¾¾: ~35,000 - 45,000 tokens</span>
        </div>

        <div class="highlight-box">
            <h4>ğŸ“Œ ThoughtChainså„æ­¥éª¤çš„max_tokensé…ç½®</h4>
            <table class="token-table">
                <tr>
                    <th>ThoughtChainå‡½æ•°</th>
                    <th>max_tokens</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
                <tr>
                    <td>attempt_to_result (with quote)</td>
                    <td>2500</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:74</span></td>
                </tr>
                <tr>
                    <td>attempt_to_result (summary)</td>
                    <td>3000</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:214</span></td>
                </tr>
                <tr>
                    <td>result_to_effect</td>
                    <td>1200</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:140</span></td>
                </tr>
                <tr>
                    <td>result_to_causal_statement</td>
                    <td>1500</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:151</span></td>
                </tr>
                <tr>
                    <td>result_to_who_what_where</td>
                    <td>1200</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:176</span></td>
                </tr>
                <tr>
                    <td>AccountForAgencyOfOthers (per player)</td>
                    <td>1500</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:347</span></td>
                </tr>
                <tr>
                    <td>event_with_quote</td>
                    <td>3500</td>
                    <td><span class="code-ref">thought_chains/thought_chains.py:307</span></td>
                </tr>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>4. å®Œæ•´æ¸¸æˆå¾ªç¯Tokenå³°å€¼è®¡ç®—</h2>

        <h3>4.1 Sequential Engineå•æ­¥å¾ªç¯</h3>
        <p>å‚è€ƒæ–‡ä»¶ï¼š<span class="code-ref">environment/engines/sequential.py:193-271</span></p>

        <div class="calculation-box">
<strong>æ¸¸æˆå¾ªç¯å•æ­¥TokenæµåŠ¨åˆ†æï¼ˆ4ç©å®¶åœºæ™¯ï¼‰ï¼š</strong>

æ­¥éª¤1: next_game_master() - NEXT_GAME_MASTER
â”œâ”€ é€šå¸¸è¿”å›å›ºå®šGMï¼Œæ— LLMè°ƒç”¨
â””â”€ Token: ~0

æ­¥éª¤2: make_observation() - MAKE_OBSERVATION (å¹¶è¡Œ)
â”œâ”€ ä¸ºæ¯ä¸ªç©å®¶ç”Ÿæˆè§‚å¯Ÿ
â”œâ”€ LLMè°ƒç”¨: 4æ¬¡ (æ¯ç©å®¶1æ¬¡)
â”œâ”€ Token per player: Input ~8,000 + Output ~300
â””â”€ <strong>æ€»Token: ~33,200 (4 players)</strong>

æ­¥éª¤3: next_acting() - NEXT_ACTING
â”œâ”€ å†³å®šä¸‹ä¸€ä¸ªè¡ŒåŠ¨çš„ç©å®¶
â”œâ”€ LLMè°ƒç”¨: 1æ¬¡
â”œâ”€ Token: Input ~10,000 + Output ~50
â””â”€ <strong>æ€»Token: ~10,050</strong>

æ­¥éª¤4: next_action_spec() - NEXT_ACTION_SPEC
â”œâ”€ å†³å®šåŠ¨ä½œç±»å‹ï¼ˆFREE/CHOICEç­‰ï¼‰
â”œâ”€ LLMè°ƒç”¨: 1æ¬¡
â”œâ”€ Token: Input ~10,000 + Output ~100
â””â”€ <strong>æ€»Token: ~10,100</strong>

æ­¥éª¤5: entity.act() - ç©å®¶æ‰§è¡ŒåŠ¨ä½œ
â”œâ”€ è§ç¬¬2èŠ‚è¯¦ç»†åˆ†æ
â””â”€ <strong>æ€»Token: ~19,000 - 25,000</strong>

æ­¥éª¤6: resolve() - RESOLVE (EventResolution)
â”œâ”€ è§ç¬¬3.2èŠ‚ThoughtChainsåˆ†æ
â””â”€ <strong>æ€»Token: ~24,000 - 45,000</strong>

æ­¥éª¤7: terminate() - TERMINATE
â”œâ”€ æ£€æŸ¥æ˜¯å¦ç»“æŸ
â”œâ”€ LLMè°ƒç”¨: 0-1æ¬¡ (é€šå¸¸0æ¬¡)
â””â”€ Token: ~0-5,000

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

<span class="warning">å•æ­¥æ¸¸æˆå¾ªç¯å³°å€¼Tokenæ€»è®¡ï¼š</span>

<span class="number-large">åŸºç¡€é…ç½®: ~96,350 - 128,350 tokens</span>
<span class="number-large">å¤æ‚é…ç½®: ~115,000 - 160,000 tokens</span>

åˆ†è§£ï¼š
â”œâ”€ make_observation (å¹¶è¡Œ):     ~33,200
â”œâ”€ next_acting:                 ~10,050
â”œâ”€ next_action_spec:            ~10,100
â”œâ”€ entity.act():                ~19,000 - 25,000
â”œâ”€ resolve (EventResolution):   ~24,000 - 45,000
â””â”€ terminate:                   ~0 - 5,000
        </div>

        <h3>4.2 ä¸åŒEngineæ¨¡å¼çš„Tokenå³°å€¼</h3>

        <table class="token-table">
            <thead>
                <tr>
                    <th>Engineç±»å‹</th>
                    <th>å¹¶è¡Œåº¦</th>
                    <th>å•æ­¥Tokenå³°å€¼</th>
                    <th>è¯´æ˜</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Sequential</strong></td>
                    <td>make_observationå¹¶è¡Œ<br>å…¶ä½™ä¸²è¡Œ</td>
                    <td class="warning">~96K - 160K</td>
                    <td>æœ€å¸¸è§é…ç½®ï¼Œmake_observationé˜¶æ®µæ‰€æœ‰ç©å®¶å¹¶è¡Œç”Ÿæˆè§‚å¯Ÿ</td>
                </tr>
                <tr>
                    <td><strong>Simultaneous</strong></td>
                    <td>æ‰€æœ‰ç©å®¶act()å¹¶è¡Œ</td>
                    <td class="warning">~100K - 200K+</td>
                    <td>å¤šä¸ªAgentåŒæ—¶act()ï¼ŒTokenå³°å€¼å€å¢</td>
                </tr>
                <tr>
                    <td><strong>Parallel</strong></td>
                    <td>æœ€å¤§å¹¶è¡Œ</td>
                    <td class="warning">~150K - 300K+</td>
                    <td>å¤šä¸ªç¯å¢ƒæ­¥éª¤å¹¶è¡Œï¼Œæé«˜Tokenæ¶ˆè€—</td>
                </tr>
            </tbody>
        </table>

        <div class="peak-box">
            <h4>ğŸš¨ Tokenå³°å€¼é£é™©ç‚¹</h4>
            <ol>
                <li><strong>make_observationå¹¶è¡Œï¼š</strong>ç©å®¶æ•° Ã— 8,300 tokensï¼Œ4ç©å®¶å°±æ˜¯33K+</li>
                <li><strong>EventResolutionçš„AccountForAgencyOfOthersï¼š</strong>æ¯å¢åŠ 1ä¸ªç©å®¶ï¼Œå¢åŠ ~3,000 tokens</li>
                <li><strong>LastNObservationså†å²ç´¯ç§¯ï¼š</strong>æ¸¸æˆè¿›è¡Œè¶Šä¹…ï¼Œè§‚å¯Ÿå†å²è¶Šé•¿ï¼ˆä¸Šé™1000æ¡ = ~30K-50K tokensï¼‰</li>
                <li><strong>Memory Bankè†¨èƒ€ï¼š</strong>è™½ç„¶æ£€ç´¢æœ‰limitï¼Œä½†contexté•¿åº¦ä»ä¼šéšæ¸¸æˆè¿›è¡Œè€Œå¢é•¿</li>
                <li><strong>Simultaneousæ¨¡å¼ä¸‹å¤šAgentå¹¶è¡Œï¼š</strong>5ä¸ªAgentåŒæ—¶act() = 5 Ã— 20K = 100K tokens</li>
            </ol>
        </div>
    </div>

    <div class="section">
        <h2>5. Memoryç³»ç»ŸTokenæ¶ˆè€—åˆ†æ</h2>

        <h3>5.1 Memoryæ£€ç´¢é‡é…ç½®</h3>

        <table class="token-table">
            <thead>
                <tr>
                    <th>ä½¿ç”¨åœºæ™¯</th>
                    <th>æ£€ç´¢æ•°é‡(æ¡)</th>
                    <th>ä¼°ç®—Tokené‡</th>
                    <th>ä»£ç ç¤ºä¾‹ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>QuestionOfRecentMemories (é»˜è®¤)</td>
                    <td>25</td>
                    <td>~2,500 - 3,750</td>
                    <td><span class="code-ref">components/agent/question_of_recent_memories.py:74</span></td>
                </tr>
                <tr>
                    <td>AllSimilarMemories (basic agent)</td>
                    <td>10</td>
                    <td>~1,000 - 1,500</td>
                    <td><span class="code-ref">prefabs/entity/basic.py:120</span></td>
                </tr>
                <tr>
                    <td>AllSimilarMemories (GM)</td>
                    <td>5</td>
                    <td>~500 - 750</td>
                    <td><span class="code-ref">prefabs/game_master/generic.py:137</span></td>
                </tr>
                <tr>
                    <td>Conversational agent</td>
                    <td>100</td>
                    <td>~10,000 - 15,000</td>
                    <td><span class="code-ref">prefabs/entity/conversational.py:175</span></td>
                </tr>
                <tr>
                    <td>å®Œæ•´å†å²ï¼ˆæ—¥å¿—/debugï¼‰</td>
                    <td>1000-10000</td>
                    <td>~100K - 1.5M</td>
                    <td><span class="code-ref">environment/deprecated/game_master.py:358</span></td>
                </tr>
            </tbody>
        </table>

        <h3>5.2 å•æ¡Memoryçš„å¹³å‡Tokenæ•°</h3>

        <div class="calculation-box">
åŸºäºç»éªŒä¼°ç®—ï¼Œå•æ¡Memoryçš„Tokenæ„æˆï¼š

<strong>è§‚å¯Ÿç±»Memoryï¼ˆObservationï¼‰ï¼š</strong>
â”œâ”€ æ—¶é—´æˆ³: ~10 tokens
â”œâ”€ ä¸»ä½“ä¿¡æ¯: ~5-10 tokens
â”œâ”€ äº‹ä»¶æè¿°: ~20-40 tokens
â””â”€ å¹³å‡: <strong>~35-60 tokens/æ¡</strong>

<strong>æ¨ç†ç±»Memoryï¼ˆReflectionï¼‰ï¼š</strong>
â”œâ”€ æ—¶é—´æˆ³: ~10 tokens
â”œâ”€ æ¨ç†æ ‡ç­¾: ~5 tokens ([self reflection], [intent reflection]ç­‰)
â”œâ”€ æ¨ç†å†…å®¹: ~50-150 tokens
â””â”€ å¹³å‡: <strong>~65-165 tokens/æ¡</strong>

<strong>åŠ¨ä½œç±»Memoryï¼ˆActionï¼‰ï¼š</strong>
â”œâ”€ æ—¶é—´æˆ³: ~10 tokens
â”œâ”€ åŠ¨ä½œè€…: ~5 tokens
â”œâ”€ åŠ¨ä½œå†…å®¹: ~15-50 tokens
â””â”€ å¹³å‡: <strong>~30-65 tokens/æ¡</strong>

<strong>åŠ æƒå¹³å‡ï¼š</strong>
å‡è®¾ç»„æˆæ¯”ä¾‹ = 50%è§‚å¯Ÿ + 30%åŠ¨ä½œ + 20%æ¨ç†
å¹³å‡Token = 0.5Ã—50 + 0.3Ã—45 + 0.2Ã—100 = <strong>~58.5 tokens/æ¡</strong>

<strong>ä¿å®ˆä¼°ç®—ï¼š</strong>æ¯æ¡Memoryçº¦ <strong>100 tokens</strong>ï¼ˆåŒ…å«æ£€ç´¢overheadï¼‰
        </div>

        <h3>5.3 Memoryæ£€ç´¢çš„Tokenæ”¾å¤§æ•ˆåº”</h3>

        <p>Memoryæ£€ç´¢ä¸ä»…ä»…æ˜¯è¿”å›åŸå§‹Memoryæ–‡æœ¬ï¼Œè¿˜åŒ…æ‹¬ï¼š</p>
        <ul>
            <li><strong>Queryæ„å»ºï¼š</strong>ç»„åˆagent_name + summaryï¼Œçº¦50-100 tokens</li>
            <li><strong>æ£€ç´¢ä¸Šä¸‹æ–‡ï¼š</strong>AssociativeMemoryBank.retrieve_associativeéœ€è¦embeddingè®¡ç®—</li>
            <li><strong>æ ¼å¼åŒ–è¾“å‡ºï¼š</strong>'\n'.join() ä¼šå¢åŠ æ¢è¡Œç¬¦</li>
            <li><strong>æ—¶é—´æˆ³æ·»åŠ ï¼š</strong>add_time=Trueæ—¶æ¯æ¡+10 tokens</li>
        </ul>

        <div class="formula">
å®é™…Memoryæ£€ç´¢Tokenå…¬å¼ï¼š

TokensRetrieved = NumMemories Ã— AvgTokensPerMemory Ã— FormatMultiplier
                = NumMemories Ã— 100 Ã— 1.15

ç¤ºä¾‹ï¼šæ£€ç´¢25æ¡ = 25 Ã— 100 Ã— 1.15 = <strong>~2,875 tokens</strong>
        </div>
    </div>

    <div class="section">
        <h2>6. Tokenå³°å€¼é¢„æµ‹æ¨¡å‹</h2>

        <h3>6.1 å½±å“Tokenå³°å€¼çš„å…³é”®å‚æ•°</h3>

        <table class="token-table">
            <thead>
                <tr>
                    <th>å‚æ•°åç§°</th>
                    <th>å…¸å‹å€¼</th>
                    <th>å¯¹Tokençš„å½±å“</th>
                    <th>æƒé‡</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>ç©å®¶æ•°é‡ (N)</strong></td>
                    <td>3-6</td>
                    <td>çº¿æ€§å¢é•¿ï¼ˆmake_observation, AccountForAgencyï¼‰</td>
                    <td class="warning">é«˜</td>
                </tr>
                <tr>
                    <td><strong>è§‚å¯Ÿå†å²é•¿åº¦ (H)</strong></td>
                    <td>100-1000</td>
                    <td>ç›´æ¥å½±å“input contextå¤§å°</td>
                    <td class="warning">é«˜</td>
                </tr>
                <tr>
                    <td><strong>Memoryæ£€ç´¢é‡ (M)</strong></td>
                    <td>10-100</td>
                    <td>æ¯æ¬¡retrievalå¢åŠ M Ã— 100 tokens</td>
                    <td>ä¸­</td>
                </tr>
                <tr>
                    <td><strong>Reflectionç»„ä»¶æ•° (R)</strong></td>
                    <td>3-6</td>
                    <td>æ¯ä¸ªç»„ä»¶å¢åŠ 1æ¬¡LLMè°ƒç”¨ï¼ˆ~4K tokensï¼‰</td>
                    <td>ä¸­</td>
                </tr>
                <tr>
                    <td><strong>ThoughtChainæ­¥éª¤æ•° (T)</strong></td>
                    <td>3-8</td>
                    <td>æ¯æ­¥å¢åŠ ~3K-5K tokens</td>
                    <td class="warning">é«˜</td>
                </tr>
                <tr>
                    <td><strong>Engineå¹¶è¡Œåº¦ (P)</strong></td>
                    <td>1-N</td>
                    <td>å¹¶è¡ŒAgentæ•° Ã— å•Agent token</td>
                    <td class="warning">æé«˜</td>
                </tr>
            </tbody>
        </table>

        <h3>6.2 Tokenå³°å€¼é¢„æµ‹å…¬å¼</h3>

        <div class="calculation-box">
<strong>å•æ­¥æ¸¸æˆå¾ªç¯Tokenå³°å€¼é¢„æµ‹å…¬å¼ï¼š</strong>

T_peak = T_observation + T_acting + T_agent + T_resolve + T_terminate

å…¶ä¸­ï¼š

<strong>T_observation (make_observation)</strong>
= N Ã— (Context_GM + max_tokens_obs)
= N Ã— (8,000 + 1,200)
= N Ã— 9,200

<strong>T_acting (next_acting + next_action_spec)</strong>
= (Context_GM + 50) + (Context_GM + 100)
= 2 Ã— Context_GM + 150
â‰ˆ 20,150

<strong>T_agent (single agent.act)</strong>
= R Ã— (M Ã— 100 + max_tokens_reflection) + H Ã— 50 + max_tokens_action
= R Ã— (M Ã— 100 + 1,000) + H Ã— 50 + 2,200

å…¸å‹å€¼(R=4, M=25, H=100):
= 4 Ã— (2,500 + 1,000) + 5,000 + 2,200
= 14,000 + 5,000 + 2,200
= <strong>21,200</strong>

<strong>T_resolve (EventResolution with ThoughtChains)</strong>
= Context_GM + T Ã— step_tokens + (N-1) Ã— agency_tokens
= 10,000 + T Ã— 3,500 + (N-1) Ã— 3,000

å…¸å‹å€¼(T=3, N=4):
= 10,000 + 3 Ã— 3,500 + 3 Ã— 3,000
= 10,000 + 10,500 + 9,000
= <strong>29,500</strong>

<strong>T_terminate</strong>
â‰ˆ 0 (é€šå¸¸æ— LLMè°ƒç”¨)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

<strong>æ€»Tokenå³°å€¼ï¼ˆå…¸å‹4ç©å®¶åœºæ™¯ï¼‰ï¼š</strong>

T_peak = (4 Ã— 9,200) + 20,150 + 21,200 + 29,500 + 0
       = 36,800 + 20,150 + 21,200 + 29,500
       = <span class="number-large">107,650 tokens</span>

<strong>ä¿å®ˆä¼°ç®—ï¼ˆè€ƒè™‘overheadï¼‰ï¼š</strong>
T_peak â‰ˆ <span class="number-large">120,000 - 130,000 tokens</span>

<strong>æç«¯æƒ…å†µï¼ˆå¤æ‚ThoughtChains, æ›´å¤šæ­¥éª¤ï¼‰ï¼š</strong>
T_peak â‰ˆ <span class="number-large">150,000 - 200,000 tokens</span>
        </div>

        <h3>6.3 ä¸åŒç©å®¶æ•°ä¸‹çš„Tokenå³°å€¼è¡¨</h3>

        <table class="token-table">
            <thead>
                <tr>
                    <th>ç©å®¶æ•°</th>
                    <th>make_observation</th>
                    <th>agent.act</th>
                    <th>EventResolution</th>
                    <th>å…¶ä»–</th>
                    <th>æ€»å³°å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2</td>
                    <td>18,400</td>
                    <td>21,200</td>
                    <td>20,500</td>
                    <td>20,150</td>
                    <td class="success">~80,250</td>
                </tr>
                <tr>
                    <td>3</td>
                    <td>27,600</td>
                    <td>21,200</td>
                    <td>25,000</td>
                    <td>20,150</td>
                    <td>~93,950</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>36,800</td>
                    <td>21,200</td>
                    <td>29,500</td>
                    <td>20,150</td>
                    <td>~107,650</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>46,000</td>
                    <td>21,200</td>
                    <td>34,000</td>
                    <td>20,150</td>
                    <td class="warning">~121,350</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>55,200</td>
                    <td>21,200</td>
                    <td>38,500</td>
                    <td>20,150</td>
                    <td class="warning">~135,050</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>73,600</td>
                    <td>21,200</td>
                    <td>47,500</td>
                    <td>20,150</td>
                    <td class="warning">~162,450</td>
                </tr>
                <tr>
                    <td>10</td>
                    <td>92,000</td>
                    <td>21,200</td>
                    <td>56,500</td>
                    <td>20,150</td>
                    <td class="warning">~189,850</td>
                </tr>
            </tbody>
        </table>

        <div class="peak-box">
            <h4>ğŸ“ˆ Tokenå³°å€¼å¢é•¿æ›²çº¿</h4>
            <p><strong>éšç©å®¶æ•°å¢é•¿ï¼š</strong></p>
            <ul>
                <li>make_observationå¢é•¿ç‡ï¼š+9,200 tokens/ç©å®¶</li>
                <li>EventResolutionå¢é•¿ç‡ï¼š+4,500 tokens/ç©å®¶ï¼ˆAccountForAgencyï¼‰</li>
                <li><strong>æ€»å¢é•¿ç‡ï¼šçº¦ +13,700 tokens/ç©å®¶</strong></li>
            </ul>
            <p><strong>æ‹ç‚¹ï¼š</strong>5ç©å®¶æ—¶çªç ´120Kï¼Œ8ç©å®¶æ—¶çªç ´160K</p>
        </div>
    </div>

    <div class="section">
        <h2>7. Tokenä¼˜åŒ–ç­–ç•¥</h2>

        <h3>7.1 å¯é…ç½®çš„Tokenæ§åˆ¶ç‚¹</h3>

        <table class="token-table">
            <thead>
                <tr>
                    <th>ä¼˜åŒ–ç‚¹</th>
                    <th>é»˜è®¤é…ç½®</th>
                    <th>å»ºè®®ä¼˜åŒ–é…ç½®</th>
                    <th>TokenèŠ‚çœ</th>
                    <th>ä»£ä»·</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>LastNObservations.history_length</td>
                    <td>100 (agent)<br>1000 (GM)</td>
                    <td>50 (agent)<br>500 (GM)</td>
                    <td>~2,500 (agent)<br>~25,000 (GM)</td>
                    <td>è¾ƒçŸ­çš„è®°å¿†çª—å£</td>
                </tr>
                <tr>
                    <td>num_memories_to_retrieve</td>
                    <td>25</td>
                    <td>15</td>
                    <td>~1,000/æ¬¡æ£€ç´¢</td>
                    <td>å¯èƒ½é—æ¼ç›¸å…³è®°å¿†</td>
                </tr>
                <tr>
                    <td>Reflectionç»„ä»¶æ•°é‡</td>
                    <td>4-6ä¸ª</td>
                    <td>2-3ä¸ª</td>
                    <td>~8,000-12,000</td>
                    <td>æ¨ç†æ·±åº¦é™ä½</td>
                </tr>
                <tr>
                    <td>ThoughtChainæ­¥éª¤æ•°</td>
                    <td>3-5æ­¥</td>
                    <td>2-3æ­¥</td>
                    <td>~7,000-14,000</td>
                    <td>äº‹ä»¶è§£æç²¾åº¦é™ä½</td>
                </tr>
                <tr>
                    <td>AllSimilarMemories.max_tokens</td>
                    <td>750</td>
                    <td>500</td>
                    <td>~250</td>
                    <td>summaryå¯èƒ½ä¸å®Œæ•´</td>
                </tr>
                <tr>
                    <td>ConcatActComponent.max_tokens</td>
                    <td>2200</td>
                    <td>1500</td>
                    <td>~700</td>
                    <td>å¤æ‚åŠ¨ä½œè¡¨è¾¾å—é™</td>
                </tr>
            </tbody>
        </table>

        <h3>7.2 æ¶æ„çº§ä¼˜åŒ–æ–¹æ¡ˆ</h3>

        <ol>
            <li>
                <strong>ä½¿ç”¨WithoutPreActå˜ä½“</strong>
                <p>è®¸å¤šç»„ä»¶æœ‰WithoutPreActç‰ˆæœ¬ï¼ˆå¦‚SelfPerceptionWithoutPreActï¼‰ï¼Œå®ƒä»¬åªè®¡ç®—ä¸è¾“å‡ºåˆ°contextï¼Œå¯å‡å°‘æœ€ç»ˆConcatActComponentçš„input tokenã€‚</p>
                <p>ä»£ç ä½ç½®ï¼š<span class="code-ref">components/agent/question_of_recent_memories.py:178-208</span></p>
            </li>
            <li>
                <strong>é€‰æ‹©æ›´è½»é‡çš„Acting Order</strong>
                <p>ä½¿ç”¨NextActingInFixedOrderæˆ–NextActingInRandomOrderä»£æ›¿åŸºäºLLMçš„NextActingï¼ŒèŠ‚çœ~10K tokens/stepã€‚</p>
                <p>ä»£ç ä½ç½®ï¼š<span class="code-ref">prefabs/game_master/generic.py:174-187</span></p>
            </li>
            <li>
                <strong>ç®€åŒ–ThoughtChains</strong>
                <p>ç§»é™¤AccountForAgencyOfOtherså¯èŠ‚çœ(N-1) Ã— 3,000 tokensï¼Œé€‚ç”¨äºä¸éœ€è¦è€ƒè™‘å…¶ä»–ç©å®¶ä¸»åŠ¨æ€§çš„åœºæ™¯ã€‚</p>
            </li>
            <li>
                <strong>ä½¿ç”¨Planç»„ä»¶ä»£æ›¿å¤šä¸ªReflection</strong>
                <p>Planç»„ä»¶å¯ä»¥æ•´åˆå¤šä¸ªé—®é¢˜ï¼Œå‡å°‘LLMè°ƒç”¨æ¬¡æ•°ã€‚</p>
                <p>ä»£ç ä½ç½®ï¼š<span class="code-ref">components/agent/plan.py</span></p>
            </li>
            <li>
                <strong>Memoryå®šæœŸæ¸…ç†</strong>
                <p>è™½ç„¶æ£€ç´¢æœ‰limitï¼Œä½†å‡å°‘Memoryæ€»é‡å¯ä»¥æé«˜æ£€ç´¢è´¨é‡å’Œé€Ÿåº¦ï¼Œé—´æ¥å‡å°‘æ— æ•ˆtokenä¼ é€’ã€‚</p>
            </li>
        </ol>

        <div class="highlight-box">
            <h4>ğŸ’¡ æœ€ä½³å®è·µå»ºè®®</h4>
            <ul>
                <li><strong>åŸå‹é˜¶æ®µï¼š</strong>ä½¿ç”¨å®Œæ•´é…ç½®ç¡®ä¿åŠŸèƒ½æ­£ç¡®</li>
                <li><strong>ä¼˜åŒ–é˜¶æ®µï¼š</strong>é€æ­¥å‡å°‘history_lengthå’Œnum_memories_to_retrieveï¼Œç›‘æ§æ€§èƒ½å˜åŒ–</li>
                <li><strong>ç”Ÿäº§ç¯å¢ƒï¼š</strong>æ ¹æ®ç©å®¶æ•°åŠ¨æ€è°ƒæ•´ï¼ˆ2-3ç©å®¶ç”¨æ ‡å‡†é…ç½®ï¼Œ5+ç©å®¶å¯ç”¨ä¼˜åŒ–é…ç½®ï¼‰</li>
                <li><strong>ç›‘æ§æŒ‡æ ‡ï¼š</strong>è®°å½•æ¯æ¬¡LLMè°ƒç”¨çš„å®é™…tokenä½¿ç”¨ï¼Œå»ºç«‹baseline</li>
            </ul>
        </div>
    </div>

    <div class="section">
        <h2>8. æ€»ç»“ä¸å…³é”®æ•°æ®é€ŸæŸ¥è¡¨</h2>

        <h3>8.1 æ ¸å¿ƒTokenå³°å€¼æ•°æ®</h3>

        <div class="peak-box">
            <table class="token-table">
                <thead>
                    <tr>
                        <th>åœºæ™¯</th>
                        <th>Tokenå³°å€¼èŒƒå›´</th>
                        <th>ä¸»è¦è´¡çŒ®è€…</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>å•æ¬¡Agent.act()</strong></td>
                        <td class="number-large">19K - 25K</td>
                        <td>Reflectionç»„ä»¶(4æ¬¡LLM) + ConcatAct(1æ¬¡)</td>
                    </tr>
                    <tr>
                        <td><strong>å•æ¬¡EventResolution</strong></td>
                        <td class="number-large">24K - 45K</td>
                        <td>ThoughtChains(3-6æ¬¡LLM) + AccountForAgency</td>
                    </tr>
                    <tr>
                        <td><strong>æ¸¸æˆå¾ªç¯å•æ­¥(4ç©å®¶)</strong></td>
                        <td class="number-large">107K - 130K</td>
                        <td>make_obs(37K) + resolve(30K) + agent.act(21K)</td>
                    </tr>
                    <tr>
                        <td><strong>æ¸¸æˆå¾ªç¯å•æ­¥(8ç©å®¶)</strong></td>
                        <td class="number-large">162K - 200K</td>
                        <td>ç©å®¶æ•°çº¿æ€§å¢é•¿æ•ˆåº”</td>
                    </tr>
                    <tr>
                        <td><strong>Simultaneous mode(4ç©å®¶)</strong></td>
                        <td class="number-large">140K - 180K</td>
                        <td>4ä¸ªAgentå¹¶è¡Œact()</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <h3>8.2 LLMè°ƒç”¨é¢‘ç‡ç»Ÿè®¡</h3>

        <div class="calculation-box">
<strong>å•æ­¥æ¸¸æˆå¾ªç¯LLMè°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ï¼ˆ4ç©å®¶ï¼Œæ ‡å‡†é…ç½®ï¼‰ï¼š</strong>

make_observationé˜¶æ®µ:
â””â”€ MakeObservation Ã— 4ç©å®¶ = <strong>4æ¬¡</strong>

actingé˜¶æ®µ:
â”œâ”€ NextActing = 1æ¬¡
â””â”€ NextActionSpec = 1æ¬¡
    å°è®¡: <strong>2æ¬¡</strong>

agent.acté˜¶æ®µ:
â”œâ”€ AllSimilarMemories.summary = 1æ¬¡
â”œâ”€ SituationPerception = 1æ¬¡
â”œâ”€ SelfPerception = 1æ¬¡
â”œâ”€ PersonBySituation = 1æ¬¡
â””â”€ ConcatActComponent = 1æ¬¡
    å°è®¡: <strong>5æ¬¡</strong>

resolveé˜¶æ®µ (ThoughtChains):
â”œâ”€ maybe_inject_narrative_push = 0-1æ¬¡
â”œâ”€ AccountForAgencyOfOthers = 3æ¬¡ (N-1ç©å®¶)
â”œâ”€ result_to_who_what_where = 1æ¬¡
â””â”€ (å¯é€‰é¢å¤–æ­¥éª¤) = 0-3æ¬¡
    å°è®¡: <strong>4-8æ¬¡</strong>

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

<strong>å•æ­¥æ€»LLMè°ƒç”¨æ¬¡æ•°: 15-19æ¬¡</strong>

ä¼°ç®—æ¯æ¬¡è°ƒç”¨å¹³å‡å¤„ç†æ—¶é—´: 1-3ç§’
<strong>å•æ­¥æ¸¸æˆå¾ªç¯æ€»æ—¶é•¿: 15-57ç§’</strong>ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰
        </div>

        <h3>8.3 TokenæµåŠ¨çƒ­åŠ›å›¾</h3>

        <div class="flow-diagram">
Tokenæ¶ˆè€—çƒ­åŠ›å›¾ï¼ˆç›¸å¯¹å æ¯”ï¼‰ï¼š

æ¸¸æˆå¾ªç¯å•æ­¥ (100% = ~110K tokens)
â”ƒ
â”£â”â” make_observation (33%)       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
â”ƒ   â””â”€ 4ç©å®¶ Ã— 9.2K each
â”ƒ
â”£â”â” EventResolution (27%)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â”œâ”€ AccountForAgency (8%)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â”œâ”€ ThoughtChains (15%)       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â””â”€ Context (4%)              â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ
â”£â”â” Agent.act (19%)              â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â”œâ”€ Reflections (11%)         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â”œâ”€ Observations (5%)         â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â””â”€ ConcatAct (3%)            â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ
â”£â”â” next_actingç³»åˆ— (18%)        â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â”œâ”€ next_acting (9%)          â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ   â””â”€ next_action_spec (9%)     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
â”ƒ
â”—â”â” terminate (3%)                â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘

<strong>ä¼˜åŒ–ä¼˜å…ˆçº§:</strong>
1. make_observation (å‡å°‘ç©å®¶æ•°æˆ–ä¼˜åŒ–MakeObservationå®ç°)
2. EventResolution (ç®€åŒ–ThoughtChainsæ­¥éª¤)
3. Agent.act (å‡å°‘Reflectionç»„ä»¶æˆ–ä½¿ç”¨WithoutPreActå˜ä½“)
        </div>
    </div>

    <div class="section">
        <h2>9. ä»£ç ç´¢å¼•ï¼šTokenç›¸å…³å…³é”®ä½ç½®</h2>

        <h3>9.1 Tokené…ç½®å®šä¹‰</h3>
        <ul>
            <li><span class="code-ref">language_model/language_model.py:27</span> - DEFAULT_MAX_TOKENS = 5000</li>
            <li><span class="code-ref">document/interactive_document.py:27-28</span> - DEFAULT_MAX_CHARACTERS, DEFAULT_MAX_TOKENS</li>
        </ul>

        <h3>9.2 Agentç»„ä»¶Tokenä½¿ç”¨</h3>
        <ul>
            <li><span class="code-ref">components/agent/all_similar_memories.py:82</span> - summaryç”Ÿæˆ max_tokens=750</li>
            <li><span class="code-ref">components/agent/question_of_recent_memories.py:74, 147</span> - num_memories=25, max_tokens=1000</li>
            <li><span class="code-ref">components/agent/plan.py:120, 140</span> - max_tokens=1000, 1200</li>
            <li><span class="code-ref">components/agent/concat_act_component.py:118, 141</span> - max_tokens=2200</li>
            <li><span class="code-ref">components/agent/observation.py:97</span> - LastNObservationsæ£€ç´¢</li>
        </ul>

        <h3>9.3 GMç»„ä»¶Tokenä½¿ç”¨</h3>
        <ul>
            <li><span class="code-ref">components/game_master/make_observation.py:166-173</span> - max_tokens=1200</li>
            <li><span class="code-ref">components/game_master/next_acting.py</span> - NextActingç³»åˆ—å®ç°</li>
            <li><span class="code-ref">components/game_master/event_resolution.py</span> - EventResolutionå…¥å£</li>
        </ul>

        <h3>9.4 ThoughtChains Tokenä½¿ç”¨</h3>
        <ul>
            <li><span class="code-ref">thought_chains/thought_chains.py:74</span> - attempt_to_result max_tokens=2500</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:140</span> - result_to_effect max_tokens=1200</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:151</span> - result_to_causal_statement max_tokens=1500</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:176</span> - result_to_who_what_where max_tokens=1200</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:214</span> - summary max_tokens=3000</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:307</span> - event_with_quote max_tokens=3500</li>
            <li><span class="code-ref">thought_chains/thought_chains.py:344-372</span> - AccountForAgencyOfOtherså®ç°</li>
        </ul>

        <h3>9.5 Prefabé…ç½®ç¤ºä¾‹</h3>
        <ul>
            <li><span class="code-ref">prefabs/entity/basic.py</span> - Basic Agentå®Œæ•´é…ç½®</li>
            <li><span class="code-ref">prefabs/entity/conversational.py:175</span> - num_memories=100é«˜Memoryé…ç½®</li>
            <li><span class="code-ref">prefabs/game_master/generic.py</span> - Generic GMå®Œæ•´é…ç½®</li>
            <li><span class="code-ref">prefabs/game_master/situated.py:135</span> - Situated GMé…ç½®</li>
        </ul>

        <h3>9.6 Engineæ¸¸æˆå¾ªç¯</h3>
        <ul>
            <li><span class="code-ref">environment/engines/sequential.py:193-271</span> - Sequentialæ¸¸æˆå¾ªç¯å®Œæ•´å®ç°</li>
        </ul>
    </div>

    <div class="highlight-box" style="margin-top: 40px; background-color: #e8f5e9; border-color: #4caf50;">
        <h3>âœ… æ–‡æ¡£å®Œæˆ</h3>
        <p><strong>æœ¬æ–‡æ¡£åŸºäºConcordiaæºç å®Œæ•´åˆ†æï¼Œæä¾›äº†ï¼š</strong></p>
        <ul>
            <li>âœ“ æ‰€æœ‰ç»„ä»¶çš„max_tokensé…ç½®è¯¦æƒ…</li>
            <li>âœ“ Memoryæ£€ç´¢çš„Tokenæ¶ˆè€—è®¡ç®—</li>
            <li>âœ“ Agent.act()å’ŒEventResolutionçš„TokenæµåŠ¨åˆ†æ</li>
            <li>âœ“ å®Œæ•´æ¸¸æˆå¾ªç¯çš„Tokenå³°å€¼é¢„æµ‹å…¬å¼</li>
            <li>âœ“ ä¸åŒç©å®¶æ•°å’Œé…ç½®ä¸‹çš„Tokenå³°å€¼è¡¨</li>
            <li>âœ“ Tokenä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µ</li>
            <li>âœ“ å®Œæ•´ä»£ç ä½ç½®ç´¢å¼•</li>
        </ul>
        <p><strong>æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š</strong>2025å¹´ï¼ˆåŸºäºConcordiaæºç åˆ†æï¼‰</p>
    </div>

</body>
</html>