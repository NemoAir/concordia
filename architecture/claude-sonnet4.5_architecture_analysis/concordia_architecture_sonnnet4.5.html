<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Concordia æ¡†æ¶æ¶æ„æ–‡æ¡£</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        h2 {
            color: #34495e;
            margin-top: 40px;
            border-left: 5px solid #3498db;
            padding-left: 15px;
        }
        h3 {
            color: #7f8c8d;
            margin-top: 25px;
        }
        .diagram {
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .code-ref {
            background: #ecf0f1;
            border-left: 4px solid #e74c3c;
            padding: 10px 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .phase {
            display: inline-block;
            padding: 8px 16px;
            margin: 5px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }
        .phase-ready { background: #95a5a6; color: white; }
        .phase-preact { background: #3498db; color: white; }
        .phase-postact { background: #9b59b6; color: white; }
        .phase-preobs { background: #1abc9c; color: white; }
        .phase-postobs { background: #16a085; color: white; }
        .phase-update { background: #e67e22; color: white; }
        .arrow {
            display: inline-block;
            margin: 0 10px;
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2em;
        }
        .component-box {
            border: 2px solid #95a5a6;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #ffffff;
        }
        .component-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        .hierarchy {
            margin-left: 20px;
            border-left: 2px solid #bdc3c7;
            padding-left: 15px;
        }
        .class-name {
            font-family: 'Courier New', monospace;
            background: #e8f4f8;
            padding: 2px 8px;
            border-radius: 3px;
            color: #2980b9;
        }
        .sequence-step {
            background: linear-gradient(to right, #ecf0f1, #ffffff);
            border-left: 4px solid #3498db;
            padding: 12px 20px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .sequence-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-weight: bold;
            margin-right: 12px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
        }
        th, td {
            border: 1px solid #bdc3c7;
            padding: 12px;
            text-align: left;
        }
        th {
            background: #34495e;
            color: white;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .note {
            background: #fff9e6;
            border: 1px solid #f39c12;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
        }
        .note::before {
            content: "ğŸ’¡ ";
            font-size: 1.2em;
        }
        pre {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        .dataflow-box {
            display: inline-block;
            padding: 10px 20px;
            margin: 8px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            text-align: center;
            min-width: 100px;
        }
        .flow-arrow {
            font-size: 1.5em;
            color: #e74c3c;
            margin: 0 15px;
        }
    </style>
</head>
<body>
    <h1>ğŸ® Concordia æ¡†æ¶æ¶æ„æ–‡æ¡£</h1>

    <div class="note">
        <strong>æ–‡æ¡£è¯´æ˜ï¼š</strong>æœ¬æ–‡æ¡£åŸºäº Concordia æ¡†æ¶æºä»£ç å®Œæ•´åˆ†æç”Ÿæˆï¼ŒåŒ…å«è¯¦ç»†çš„æ¶æ„å›¾ã€æ—¶åºå›¾ã€æ•°æ®æµå›¾å’Œä»£ç å¼•ç”¨ã€‚æ‰€æœ‰ä¿¡æ¯å‡æ¥è‡ª concordia æ–‡ä»¶å¤¹çš„æºç å®ç°ã€‚
    </div>

    <h2>ğŸ“‹ ç›®å½•</h2>
    <ol>
        <li><a href="#class-hierarchy">ç³»ç»Ÿç±»ç»§æ‰¿ä¸ç»„åˆå…³ç³»æ¶æ„</a></li>
        <li><a href="#phase-state-machine">Phase çŠ¶æ€æœºå¾ªç¯æœºåˆ¶</a></li>
        <li><a href="#agent-behavior-sequence">Agent è¡Œä¸ºè°ƒç”¨æ—¶åº</a></li>
        <li><a href="#data-flow">æ•°æ®æµæ¦‚è§ˆ</a></li>
        <li><a href="#component-details">ç»„ä»¶ç³»ç»Ÿè¯¦è§£</a></li>
    </ol>

    <h2 id="class-hierarchy">1. ç³»ç»Ÿç±»ç»§æ‰¿ä¸ç»„åˆå…³ç³»æ¶æ„</h2>

    <div class="diagram">
        <h3>1.1 Entity ç»§æ‰¿å±‚æ¬¡ç»“æ„</h3>
        <div class="component-box">
            <div class="component-title">Entityï¼ˆæŠ½è±¡åŸºç±»ï¼‰</div>
            <div class="code-ref">ğŸ“ concordia/typing/entity.py:192-236</div>
            <ul>
                <li><strong>æ ¸å¿ƒæ–¹æ³•ï¼š</strong>
                    <ul>
                        <li><span class="class-name">act(action_spec: ActionSpec) â†’ str</span></li>
                        <li><span class="class-name">observe(observation: str) â†’ None</span></li>
                        <li><span class="class-name">name: str</span> (cached_property)</li>
                    </ul>
                </li>
            </ul>

            <div class="hierarchy">
                <div class="component-box">
                    <div class="component-title">EntityWithLogging(Entity)</div>
                    <div class="code-ref">ğŸ“ concordia/typing/entity.py:238-244</div>
                    <ul>
                        <li><span class="class-name">get_last_log() â†’ dict[str, Any]</span></li>
                    </ul>
                </div>

                <div class="component-box">
                    <div class="component-title">EntityAgent(Entity)</div>
                    <div class="code-ref">ğŸ“ concordia/agents/entity_agent.py:40-399</div>
                    <ul>
                        <li><strong>ç»„åˆå…³ç³»ï¼š</strong>
                            <ul>
                                <li>åŒ…å«å¤šä¸ª <span class="class-name">ContextComponent</span></li>
                                <li>åŒ…å«ä¸€ä¸ª <span class="class-name">ActingComponent</span></li>
                                <li>åŒ…å«ä¸€ä¸ª <span class="class-name">ContextProcessorComponent</span></li>
                            </ul>
                        </li>
                        <li><strong>èŒè´£ï¼š</strong>ç®¡ç† Phase è½¬æ¢å’Œç»„ä»¶è°ƒç”¨</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="diagram">
        <h3>1.2 Component ç»§æ‰¿å±‚æ¬¡ç»“æ„</h3>

        <div class="component-box">
            <div class="component-title">ContextComponentï¼ˆä¸Šä¸‹æ–‡ç»„ä»¶ï¼‰</div>
            <div class="code-ref">ğŸ“ concordia/typing/entity_component.py:192-250</div>
            <p><strong>ä½œç”¨ï¼š</strong>åœ¨ PRE_ACT é˜¶æ®µæä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ç»™ ActingComponent</p>

            <div class="hierarchy">
                <h4>ActionSpecIgnoredï¼ˆå¾ˆå¤šç»„ä»¶çš„åŸºç±»ï¼‰</h4>
                <div class="code-ref">ğŸ“ concordia/components/agent/action_spec_ignored.py:26-101</div>
                <p><strong>ç‰¹ç‚¹ï¼š</strong>å¿½ç•¥ action_specï¼Œå®ç° pre_act å€¼ç¼“å­˜ï¼Œå­ç±»åªéœ€å®ç° _make_pre_act_value()</p>

                <div class="hierarchy">
                    <h4>Constant - å¸¸é‡ç»„ä»¶</h4>
                    <div class="code-ref">ğŸ“ concordia/components/agent/constant.py:23-59</div>
                    <ul>
                        <li>Instructionsï¼ˆAgentï¼‰ - ğŸ“ concordia/components/agent/instructions.py:22-44</li>
                        <li>Instructionsï¼ˆGMï¼‰ - ğŸ“ concordia/components/game_master/instructions.py:72-100</li>
                        <li>PlayerCharacters - ğŸ“ concordia/components/game_master/instructions.py:103-113</li>
                    </ul>

                    <h4>Plan - è®¡åˆ’ç»„ä»¶</h4>
                    <div class="code-ref">ğŸ“ concordia/components/agent/plan.py:27-163</div>
                    <p>ä½¿ç”¨ LLM ç”Ÿæˆå’Œæ›´æ–°æ™ºèƒ½ä½“çš„è®¡åˆ’</p>

                    <h4>QuestionOfRecentMemories ç³»åˆ—</h4>
                    <div class="code-ref">ğŸ“ concordia/components/agent/question_of_recent_memories.py:51-400</div>
                    <ul>
                        <li>SelfPerception - "æ™ºèƒ½ä½“æ˜¯ä»€ä¹ˆæ ·çš„äººï¼Ÿ"</li>
                        <li>SituationPerception - "å½“å‰æ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ"</li>
                        <li>PersonBySituation - "è¿™æ ·çš„äººä¼šåšä»€ä¹ˆï¼Ÿ"</li>
                        <li>AvailableOptionsPerception - "æœ‰å“ªäº›å¯ç”¨è¡ŒåŠ¨ï¼Ÿ"</li>
                        <li>BestOptionPerception - "å“ªä¸ªè¡ŒåŠ¨æœ€å¥½ï¼Ÿ"</li>
                    </ul>

                    <h4>Observation ç³»åˆ—</h4>
                    <div class="code-ref">ğŸ“ concordia/components/agent/observation.py:29-177</div>
                    <ul>
                        <li>ObservationToMemory - åœ¨ pre_observe ä¸­å°†è§‚å¯Ÿæ·»åŠ åˆ° memory</li>
                        <li>LastNObservations - æ£€ç´¢æœ€è¿‘ N ä¸ªè§‚å¯Ÿ</li>
                        <li>ObservationsSinceLastPreAct - æ£€ç´¢è‡ªä¸Šæ¬¡ pre_act ä»¥æ¥çš„è§‚å¯Ÿ</li>
                    </ul>
                </div>

                <h4>Memory ç»„ä»¶</h4>
                <div class="code-ref">ğŸ“ concordia/components/agent/memory.py:32-426</div>
                <ul>
                    <li>Memory - åŸºç¡€è®°å¿†ç»„ä»¶ï¼ˆæŠ½è±¡åŸºç±»ï¼‰</li>
                    <li>AssociativeMemory - ä½¿ç”¨ AssociativeMemoryBank çš„è”æƒ³è®°å¿†</li>
                    <li>ListMemory - ä½¿ç”¨ç®€å•åˆ—è¡¨çš„è®°å¿†</li>
                </ul>
            </div>
        </div>

        <div class="component-box">
            <div class="component-title">ActingComponentï¼ˆè¡ŒåŠ¨ç»„ä»¶ï¼‰</div>
            <div class="code-ref">ğŸ“ concordia/typing/entity_component.py:253-297</div>
            <p><strong>ä½œç”¨ï¼š</strong>èšåˆæ‰€æœ‰ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ LLM ç”Ÿæˆè¡ŒåŠ¨</p>

            <div class="hierarchy">
                <h4>ConcatActComponent</h4>
                <div class="code-ref">ğŸ“ concordia/components/agent/concat_act_component.py:26-181</div>
                <p><strong>æ ‡å‡†å®ç°ï¼š</strong>è¿æ¥æ‰€æœ‰ ContextComponent çš„è¾“å‡ºï¼Œä½¿ç”¨ InteractiveDocument + LLM ç”Ÿæˆè¡ŒåŠ¨</p>
                <ul>
                    <li>æ”¯æŒ FREE, CHOICE, FLOAT ä¸‰ç§è¾“å‡ºç±»å‹</li>
                    <li>å¯é…ç½®ç»„ä»¶é¡ºåº (component_order)</li>
                </ul>
            </div>
        </div>

        <div class="component-box">
            <div class="component-title">ContextProcessorComponentï¼ˆä¸Šä¸‹æ–‡å¤„ç†å™¨ï¼‰</div>
            <div class="code-ref">ğŸ“ concordia/typing/entity_component.py:300-325</div>
            <p><strong>ä½œç”¨ï¼š</strong>åœ¨ PRE_ACT å’Œ POST_ACT é˜¶æ®µå¤„ç†ä¸Šä¸‹æ–‡</p>

            <div class="hierarchy">
                <h4>NoOpContextProcessor</h4>
                <div class="code-ref">ğŸ“ concordia/components/agent/no_op_context_processor.py:20-22</div>
                <p>ä»€ä¹ˆéƒ½ä¸åšçš„é»˜è®¤å®ç°</p>
            </div>
        </div>
    </div>

    <div class="diagram">
        <h3>1.3 Game Master ä¸“ç”¨ç»„ä»¶</h3>

        <table>
            <thead>
                <tr>
                    <th>ç»„ä»¶åç§°</th>
                    <th>ä½œç”¨</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span class="class-name">MakeObservation</span></td>
                    <td>ä¸ºç©å®¶ç”Ÿæˆè§‚å¯Ÿï¼Œä½¿ç”¨é˜Ÿåˆ—ç³»ç»Ÿç®¡ç†äº‹ä»¶</td>
                    <td>ğŸ“ concordia/components/game_master/make_observation.py:30-177</td>
                </tr>
                <tr>
                    <td><span class="class-name">EventResolution</span></td>
                    <td>å°† putative events è½¬æ¢ä¸ºå®é™…äº‹ä»¶ï¼Œä½¿ç”¨ thought_chains</td>
                    <td>ğŸ“ concordia/components/game_master/event_resolution.py:29-212</td>
                </tr>
                <tr>
                    <td><span class="class-name">NextActing</span></td>
                    <td>å†³å®šä¸‹ä¸€ä¸ªè¡ŒåŠ¨çš„å®ä½“ï¼ˆå¤šç§å˜ä½“ï¼šå›ºå®šé¡ºåºã€éšæœºã€åŸºäºåœºæ™¯ç­‰ï¼‰</td>
                    <td>ğŸ“ concordia/components/game_master/next_acting.py:27-457</td>
                </tr>
                <tr>
                    <td><span class="class-name">Terminate</span></td>
                    <td>å†³å®šæ˜¯å¦ç»ˆæ­¢æ¨¡æ‹Ÿ</td>
                    <td>ğŸ“ concordia/components/game_master/terminate.py:25-105</td>
                </tr>
                <tr>
                    <td><span class="class-name">NextGameMaster</span></td>
                    <td>åœ¨å¤šä¸ª GM è§„åˆ™é›†ä¹‹é—´åˆ‡æ¢</td>
                    <td>ğŸ“ concordia/components/game_master/next_game_master.py:34-133</td>
                </tr>
                <tr>
                    <td><span class="class-name">WorldState</span></td>
                    <td>è¿½è¸ªä¸–ç•ŒçŠ¶æ€å˜é‡</td>
                    <td>ğŸ“ concordia/components/game_master/world_state.py:26-159</td>
                </tr>
                <tr>
                    <td><span class="class-name">Locations</span></td>
                    <td>è¿½è¸ªå®ä½“çš„ä½ç½®</td>
                    <td>ğŸ“ concordia/components/game_master/world_state.py:161-325</td>
                </tr>
                <tr>
                    <td><span class="class-name">GenerativeClock</span></td>
                    <td>ä½¿ç”¨ LLM æ›´æ–°çš„ç”Ÿæˆå¼æ—¶é’Ÿ</td>
                    <td>ğŸ“ concordia/components/game_master/world_state.py:327-484</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="diagram">
        <h3>1.4 Engine å±‚æ¬¡ç»“æ„</h3>

        <div class="component-box">
            <div class="component-title">Engineï¼ˆæŠ½è±¡åŸºç±»ï¼‰</div>
            <div class="code-ref">ğŸ“ concordia/environment/engine.py:23-243</div>
            <p><strong>æ ¸å¿ƒæ–¹æ³•ï¼š</strong></p>
            <ul>
                <li><span class="class-name">make_observation(game_master, entities)</span></li>
                <li><span class="class-name">next_acting(game_master, entities) â†’ (Entity, ActionSpec)</span></li>
                <li><span class="class-name">resolve(game_master, putative_event)</span></li>
                <li><span class="class-name">terminate(game_master) â†’ bool</span></li>
                <li><span class="class-name">next_game_master(game_master) â†’ Entity</span></li>
                <li><span class="class-name">run_loop(game_master, entities, max_steps)</span></li>
            </ul>

            <div class="hierarchy">
                <div class="component-box">
                    <div class="component-title">Sequentialï¼ˆé¡ºåºæ‰§è¡Œå¼•æ“ï¼‰</div>
                    <div class="code-ref">ğŸ“ concordia/environment/engines/sequential.py:43-271</div>
                    <p><strong>ç‰¹ç‚¹ï¼š</strong>å®ç°å®Œæ•´çš„æ¸¸æˆå¾ªç¯ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªæ­¥éª¤</p>
                </div>
            </div>
        </div>
    </div>

    <div class="diagram">
        <h3>1.5 Memory ç³»ç»Ÿå±‚æ¬¡ç»“æ„</h3>

        <div class="component-box">
            <div class="component-title">AssociativeMemoryBank</div>
            <div class="code-ref">ğŸ“ concordia/associative_memory/basic_associative_memory.py:50-548</div>
            <p><strong>æ ¸å¿ƒåŠŸèƒ½ï¼š</strong></p>
            <ul>
                <li><span class="class-name">add(text, metadata, importance=1.0)</span> - æ·»åŠ è®°å¿†</li>
                <li><span class="class-name">retrieve_associative(query, k, use_recency, add_time) â†’ list[str]</span> - åŸºäºä½™å¼¦ç›¸ä¼¼åº¦çš„è”æƒ³æ£€ç´¢</li>
                <li><span class="class-name">retrieve_recent(k, add_time) â†’ list[str]</span> - æ£€ç´¢æœ€è¿‘çš„è®°å¿†</li>
                <li><span class="class-name">scan(predicate) â†’ list[str]</span> - æ‰«ææ‰€æœ‰è®°å¿†</li>
            </ul>
            <p><strong>åŸç†ï¼š</strong>ä½¿ç”¨å‘é‡åµŒå…¥ï¼ˆembeddingsï¼‰å­˜å‚¨è®°å¿†ï¼Œé€šè¿‡ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—ç›¸å…³æ€§</p>
        </div>
    </div>

    <div class="diagram">
        <h3>1.6 Document ç³»ç»Ÿå±‚æ¬¡ç»“æ„</h3>

        <div class="component-box">
            <div class="component-title">Document</div>
            <div class="code-ref">ğŸ“ concordia/document/document.py:20-234</div>
            <p><strong>åŸºç¡€æ–‡æ¡£ç³»ç»Ÿï¼š</strong>ç®¡ç†å¸¦æ ‡ç­¾çš„å†…å®¹å—</p>

            <div class="hierarchy">
                <div class="component-box">
                    <div class="component-title">InteractiveDocument(Document)</div>
                    <div class="code-ref">ğŸ“ concordia/document/interactive_document.py:48-351</div>
                    <p><strong>ä¸ LLM äº¤äº’çš„æ–‡æ¡£ç³»ç»Ÿï¼š</strong></p>
                    <ul>
                        <li><span class="class-name">statement(text)</span> - æ·»åŠ é™ˆè¿°</li>
                        <li><span class="class-name">debug(text)</span> - æ·»åŠ è°ƒè¯•ä¿¡æ¯</li>
                        <li><span class="class-name">open_question(question, max_tokens, terminators) â†’ str</span> - å¼€æ”¾å¼é—®é¢˜</li>
                        <li><span class="class-name">open_question_diversified(question, num_samples) â†’ str</span> - å¤šæ ·åŒ–é‡‡æ ·</li>
                        <li><span class="class-name">multiple_choice_question(question, answers) â†’ int</span> - å¤šé€‰é¢˜</li>
                        <li><span class="class-name">yes_no_question(question) â†’ bool</span> - æ˜¯/å¦é—®é¢˜</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <h2 id="phase-state-machine">2. Phase çŠ¶æ€æœºå¾ªç¯æœºåˆ¶</h2>

    <div class="diagram">
        <h3>2.1 Phase æšä¸¾å®šä¹‰</h3>
        <div class="code-ref">ğŸ“ concordia/typing/entity_component.py:28-46</div>
        <pre>class Phase(enum.Enum):
    READY = 'ready'          # åˆå§‹çŠ¶æ€ï¼Œå‡†å¤‡å¥½æ¥æ”¶æ–°çš„ act æˆ– observe è°ƒç”¨
    PRE_ACT = 'pre_act'      # å‡†å¤‡è¡ŒåŠ¨ï¼šæ”¶é›†ä¸Šä¸‹æ–‡
    POST_ACT = 'post_act'    # è¡ŒåŠ¨åï¼šå¤„ç†è¡ŒåŠ¨ç»“æœ
    PRE_OBSERVE = 'pre_observe'    # å‡†å¤‡è§‚å¯Ÿï¼šæ¥æ”¶è§‚å¯Ÿ
    POST_OBSERVE = 'post_observe'  # è§‚å¯Ÿåï¼šå¤„ç†è§‚å¯Ÿ
    UPDATE = 'update'        # æ›´æ–°ï¼šæäº¤æ‰€æœ‰ç¼“å­˜çš„æ›´æ”¹</pre>
    </div>

    <div class="diagram">
        <h3>2.2 act() çš„ Phase çŠ¶æ€è½¬æ¢</h3>
        <div class="code-ref">ğŸ“ concordia/agents/entity_agent.py:194-247</div>

        <div style="text-align: center; margin: 30px 0;">
            <span class="phase phase-ready">READY</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-preact">PRE_ACT</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-postact">POST_ACT</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-update">UPDATE</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-ready">READY</span>
        </div>

        <h4>è¯¦ç»†æ­¥éª¤ï¼š</h4>
        <div class="sequence-step">
            <span class="sequence-number">1</span>
            <strong>READY â†’ PRE_ACTï¼š</strong>è¿›å…¥å‡†å¤‡è¡ŒåŠ¨é˜¶æ®µ
            <div class="code-ref">entity_agent.py:194-195</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">2</span>
            <strong>PRE_ACT é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ ContextComponent çš„ <span class="class-name">pre_act(action_spec)</span>
            <div class="code-ref">entity_agent.py:196-203</div>
            <ul>
                <li>æ”¶é›†æ‰€æœ‰ä¸Šä¸‹æ–‡ï¼š<span class="class-name">contexts = {component_name: context_string}</span></li>
                <li>å„ç»„ä»¶å¯èƒ½ä» Memory æ£€ç´¢ä¿¡æ¯ã€ç”Ÿæˆè®¡åˆ’ã€è‡ªæˆ‘åæ€ç­‰</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">3</span>
            <strong>è°ƒç”¨ ContextProcessorï¼š</strong><span class="class-name">context_processor.pre_act(contexts)</span>
            <div class="code-ref">entity_agent.py:204-206</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">4</span>
            <strong>ç”Ÿæˆè¡ŒåŠ¨ï¼š</strong><span class="class-name">act_component.get_action_attempt(contexts, action_spec)</span>
            <div class="code-ref">entity_agent.py:207-212</div>
            <ul>
                <li>ActingComponent èšåˆæ‰€æœ‰ä¸Šä¸‹æ–‡</li>
                <li>ä½¿ç”¨ InteractiveDocument + LLM ç”Ÿæˆè¡ŒåŠ¨</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">5</span>
            <strong>PRE_ACT â†’ POST_ACTï¼š</strong>è¿›å…¥è¡ŒåŠ¨åé˜¶æ®µ
            <div class="code-ref">entity_agent.py:214-215</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">6</span>
            <strong>POST_ACT é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <span class="class-name">post_act(action_attempt)</span>
            <div class="code-ref">entity_agent.py:216-223</div>
            <ul>
                <li>å„ç»„ä»¶å¯ä»¥å¤„ç†åˆšåˆšç”Ÿæˆçš„è¡ŒåŠ¨</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">7</span>
            <strong>è°ƒç”¨ ContextProcessorï¼š</strong><span class="class-name">context_processor.post_act(contexts)</span>
            <div class="code-ref">entity_agent.py:224-226</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">8</span>
            <strong>POST_ACT â†’ UPDATEï¼š</strong>è¿›å…¥æ›´æ–°é˜¶æ®µ
            <div class="code-ref">entity_agent.py:228-229</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">9</span>
            <strong>UPDATE é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <span class="class-name">update()</span>
            <div class="code-ref">entity_agent.py:230-237</div>
            <ul>
                <li>Memory ç»„ä»¶æäº¤ç¼“å­˜çš„è®°å¿†åˆ° AssociativeMemoryBank</li>
                <li>ActionSpecIgnored ç»„ä»¶æ¸…é™¤ç¼“å­˜çš„ pre_act å€¼</li>
                <li>å„ç»„ä»¶é‡ç½®å†…éƒ¨çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€æ¬¡è°ƒç”¨</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">10</span>
            <strong>UPDATE â†’ READYï¼š</strong>å›åˆ°å°±ç»ªçŠ¶æ€
            <div class="code-ref">entity_agent.py:239-240</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">11</span>
            <strong>è¿”å›è¡ŒåŠ¨ï¼š</strong>è¿”å› <span class="class-name">action_attempt</span>
            <div class="code-ref">entity_agent.py:242-247</div>
        </div>
    </div>

    <div class="diagram">
        <h3>2.3 observe() çš„ Phase çŠ¶æ€è½¬æ¢</h3>
        <div class="code-ref">ğŸ“ concordia/agents/entity_agent.py:249-293</div>

        <div style="text-align: center; margin: 30px 0;">
            <span class="phase phase-ready">READY</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-preobs">PRE_OBSERVE</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-postobs">POST_OBSERVE</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-update">UPDATE</span>
            <span class="arrow">â†’</span>
            <span class="phase phase-ready">READY</span>
        </div>

        <h4>è¯¦ç»†æ­¥éª¤ï¼š</h4>
        <div class="sequence-step">
            <span class="sequence-number">1</span>
            <strong>READY â†’ PRE_OBSERVEï¼š</strong>è¿›å…¥å‡†å¤‡è§‚å¯Ÿé˜¶æ®µ
            <div class="code-ref">entity_agent.py:249-250</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">2</span>
            <strong>PRE_OBSERVE é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <span class="class-name">pre_observe(observation)</span>
            <div class="code-ref">entity_agent.py:251-258</div>
            <ul>
                <li>ObservationToMemory ç»„ä»¶å°†è§‚å¯Ÿæ·»åŠ åˆ° Memoryï¼ˆå¸¦ [observation] æ ‡ç­¾ï¼‰</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">3</span>
            <strong>è°ƒç”¨ ContextProcessorï¼š</strong><span class="class-name">context_processor.pre_observe()</span>
            <div class="code-ref">entity_agent.py:259-261</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">4</span>
            <strong>PRE_OBSERVE â†’ POST_OBSERVEï¼š</strong>è¿›å…¥è§‚å¯Ÿåé˜¶æ®µ
            <div class="code-ref">entity_agent.py:263-264</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">5</span>
            <strong>POST_OBSERVE é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <span class="class-name">post_observe()</span>
            <div class="code-ref">entity_agent.py:265-272</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">6</span>
            <strong>è°ƒç”¨ ContextProcessorï¼š</strong><span class="class-name">context_processor.post_observe()</span>
            <div class="code-ref">entity_agent.py:273-275</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">7</span>
            <strong>POST_OBSERVE â†’ UPDATEï¼š</strong>è¿›å…¥æ›´æ–°é˜¶æ®µ
            <div class="code-ref">entity_agent.py:277-278</div>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">8</span>
            <strong>UPDATE é˜¶æ®µï¼š</strong>å¹¶è¡Œè°ƒç”¨æ‰€æœ‰ç»„ä»¶çš„ <span class="class-name">update()</span>
            <div class="code-ref">entity_agent.py:279-286</div>
            <ul>
                <li>Memory ç»„ä»¶æäº¤ç¼“å­˜çš„è§‚å¯Ÿè®°å¿†</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">9</span>
            <strong>UPDATE â†’ READYï¼š</strong>å›åˆ°å°±ç»ªçŠ¶æ€
            <div class="code-ref">entity_agent.py:288-293</div>
        </div>
    </div>

    <div class="note">
        <strong>è®¾è®¡è¦ç‚¹ï¼š</strong>Phase çŠ¶æ€æœºç¡®ä¿äº†ç»„ä»¶è°ƒç”¨çš„ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨æ€§ã€‚æ‰€æœ‰ç»„ä»¶åœ¨ç‰¹å®š Phase ä¸‹æ‰§è¡Œç‰¹å®šæ“ä½œï¼Œé¿å…äº†çŠ¶æ€æ··ä¹±ã€‚ActionSpecIgnored ç»„ä»¶åˆ©ç”¨è¿™ä¸€æœºåˆ¶å®ç°äº†å®‰å…¨çš„è·¨ç»„ä»¶æ•°æ®è®¿é—®ã€‚
    </div>

    <h2 id="agent-behavior-sequence">3. Agent è¡Œä¸ºè°ƒç”¨æ—¶åº</h2>

    <div class="diagram">
        <h3>3.1 æ¸¸æˆä¸»å¾ªç¯æ—¶åºï¼ˆEngine.run_loopï¼‰</h3>
        <div class="code-ref">ğŸ“ concordia/environment/engines/sequential.py:193-271</div>

        <div class="sequence-step">
            <span class="sequence-number">0</span>
            <strong>åˆå§‹åŒ–ï¼š</strong>å¼€å§‹æ¸¸æˆå¾ªç¯
            <div class="code-ref">sequential.py:193-201</div>
            <pre>while not self.terminate(game_master, verbose) and steps < max_steps:</pre>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">1</span>
            <strong>é€‰æ‹© Game Masterï¼š</strong><span class="class-name">Engine.next_game_master(game_master)</span>
            <div class="code-ref">sequential.py:202-207</div>
            <ul>
                <li>å¦‚æœæœ‰å¤šä¸ª GM è§„åˆ™é›†ï¼Œé€‰æ‹©ä¸‹ä¸€ä¸ªè¦ä½¿ç”¨çš„ GM</li>
                <li>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=NEXT_GAME_MASTER))</span></li>
                <li>NextGameMaster ç»„ä»¶ä½¿ç”¨ LLM ä»é€‰é¡¹ä¸­é€‰æ‹©</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">2</span>
            <strong>ç”Ÿæˆè§‚å¯Ÿï¼š</strong><span class="class-name">Engine.make_observation(game_master, entities)</span>
            <div class="code-ref">sequential.py:208-222</div>
            <p><strong>æ ¸å¿ƒé€»è¾‘ï¼š</strong></p>
            <ul>
                <li>å¹¶è¡Œä¸ºæ‰€æœ‰å®ä½“ç”Ÿæˆè§‚å¯Ÿï¼ˆä½¿ç”¨ concurrency.run_tasksï¼‰</li>
                <li>æ¯ä¸ªå®ä½“çš„è§‚å¯Ÿç”Ÿæˆæµç¨‹ï¼š
                    <ol>
                        <li>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=MAKE_OBSERVATION, call_to_action="{name}è§‚å¯Ÿä»€ä¹ˆï¼Ÿ"))</span></li>
                        <li>MakeObservation ç»„ä»¶ä»é˜Ÿåˆ—ä¸­å–å‡ºäº‹ä»¶ï¼Œä½¿ç”¨ LLM ç”Ÿæˆè§‚å¯Ÿæ–‡æœ¬</li>
                        <li>è°ƒç”¨ <span class="class-name">entity.observe(observation)</span></li>
                        <li>å®ä½“è§¦å‘ observe() æµç¨‹ï¼ˆè§ 2.3ï¼‰</li>
                    </ol>
                </li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">3</span>
            <strong>å†³å®šä¸‹ä¸€ä¸ªè¡ŒåŠ¨è€…ï¼š</strong><span class="class-name">Engine.next_acting(game_master, entities)</span>
            <div class="code-ref">sequential.py:223-237</div>
            <p><strong>åˆ†ä¸ºä¸¤æ­¥ï¼š</strong></p>
            <ol>
                <li><strong>é€‰æ‹©å®ä½“ï¼š</strong>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=NEXT_ACTING))</span>
                    <ul>
                        <li>NextActing ç»„ä»¶è¿”å›å®ä½“åç§°</li>
                        <li>å¤šç§ç­–ç•¥ï¼šå›ºå®šé¡ºåºã€éšæœºã€åŸºäºåœºæ™¯ç­‰</li>
                    </ul>
                </li>
                <li><strong>ç¡®å®š ActionSpecï¼š</strong>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=NEXT_ACTION_SPEC, call_to_action="{name}çš„è¡ŒåŠ¨è§„æ ¼æ˜¯ä»€ä¹ˆï¼Ÿ"))</span>
                    <ul>
                        <li>è¿”å›æ ¼å¼ï¼š<span class="class-name">"prompt: What would {name} do?;;type: choice;;options: option1, option2, option3"</span></li>
                        <li>æˆ–ï¼š<span class="class-name">"prompt: What would {name} say?;;type: free"</span></li>
                    </ul>
                </li>
            </ol>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">4</span>
            <strong>å®ä½“æ‰§è¡Œè¡ŒåŠ¨ï¼š</strong><span class="class-name">entity.act(action_spec)</span>
            <div class="code-ref">sequential.py:238-249</div>
            <p><strong>è§¦å‘å®ä½“çš„ act() æµç¨‹ï¼ˆè§ 2.2ï¼‰ï¼š</strong></p>
            <ul>
                <li>Phase è½¬æ¢ï¼šREADY â†’ PRE_ACT â†’ POST_ACT â†’ UPDATE â†’ READY</li>
                <li>æ‰€æœ‰ ContextComponent æä¾›ä¸Šä¸‹æ–‡</li>
                <li>ActingComponent ä½¿ç”¨ LLM ç”Ÿæˆè¡ŒåŠ¨</li>
                <li>è¿”å› action_attempt å­—ç¬¦ä¸²</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">5</span>
            <strong>è§£æäº‹ä»¶ï¼š</strong><span class="class-name">Engine.resolve(game_master, putative_event=action)</span>
            <div class="code-ref">sequential.py:250-263</div>
            <p><strong>GM è§£æäº‹ä»¶æµç¨‹ï¼š</strong></p>
            <ul>
                <li>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=RESOLVE, call_to_action="è§£æäº‹ä»¶: {putative_event}"))</span></li>
                <li>EventResolution ç»„ä»¶ä½¿ç”¨ thought_chains å¤„ç†ï¼š
                    <ol>
                        <li><span class="class-name">attempt_to_result(attempt, state)</span> - å°†å°è¯•è½¬æ¢ä¸ºç»“æœ</li>
                        <li><span class="class-name">determine_success_and_why(attempt, result)</span> - åˆ¤æ–­æˆåŠŸä¸å¦</li>
                        <li><span class="class-name">result_to_effect_on_state(result, state)</span> - è½¬æ¢ä¸ºçŠ¶æ€æ•ˆæœ</li>
                    </ol>
                </li>
                <li>è¿”å›è§£æåçš„å®é™…äº‹ä»¶æ–‡æœ¬</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">6</span>
            <strong>äº‹ä»¶å…¥é˜Ÿï¼š</strong>å°†è§£æåçš„äº‹ä»¶æ·»åŠ åˆ° MakeObservation çš„é˜Ÿåˆ—
            <div class="code-ref">sequential.py:264-267</div>
            <ul>
                <li>è¿™äº›äº‹ä»¶å°†åœ¨ä¸‹ä¸€è½®çš„ make_observation ä¸­è¢«è½¬æ¢ä¸ºè§‚å¯Ÿ</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">7</span>
            <strong>æ£€æŸ¥ç»ˆæ­¢ï¼š</strong><span class="class-name">Engine.terminate(game_master)</span>
            <div class="code-ref">sequential.py:268-271</div>
            <ul>
                <li>GM è°ƒç”¨ <span class="class-name">act(ActionSpec(output_type=TERMINATE))</span></li>
                <li>Terminate ç»„ä»¶è¿”å› "Yes" æˆ– "No"</li>
            </ul>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">8</span>
            <strong>å¾ªç¯ç»§ç»­ï¼š</strong>å¦‚æœæœªç»ˆæ­¢ä¸”æœªè¾¾åˆ°æœ€å¤§æ­¥æ•°ï¼Œå›åˆ°æ­¥éª¤ 1
        </div>
    </div>

    <div class="diagram">
        <h3>3.2 å®Œæ•´æ—¶åºå›¾ï¼ˆå•ä¸ªå¾ªç¯æ­¥ï¼‰</h3>

        <pre style="background: white; color: #2c3e50; border: 2px solid #3498db; padding: 20px;">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”
â”‚ Engine  â”‚     â”‚   GM   â”‚     â”‚ Entity â”‚     â”‚ Components â”‚     â”‚ LLM â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€ï¿½     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”¬â”€â”€â”˜
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 1. next_game_master(GM)    â”‚                â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(NEXT_GAME_MASTER)         â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ pre_act()      â”‚               â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€contextsâ”€â”€â”€â”€â”¤               â”‚
     â”‚              â”‚              â”‚ get_action_attempt()           â”‚
     â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚<â”€gm_nameâ”€â”€â”€â”€â”€â”¤<â”€â”€â”€responseâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚<â”€gm_nameâ”€â”€â”€â”€â”€â”¤              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 2. make_observation(GM, [entities]) (å¹¶è¡Œ)   â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(MAKE_OBSERVATION)         â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ pre_act()      â”‚               â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€contextsâ”€â”€â”€â”€â”¤               â”‚
     â”‚              â”‚              â”‚ LLMç”Ÿæˆè§‚å¯Ÿ    â”‚               â”‚
     â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚<â”€observationâ”€â”¤<â”€â”€â”€responseâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ æ¯ä¸ªå®ä½“: entity.observe(obs)  â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ PRE_OBSERVE    â”‚               â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚              â”‚              â”‚ pre_observe()  â”‚               â”‚
     â”‚              â”‚              â”‚ (æ·»åŠ åˆ°Memory) â”‚               â”‚
     â”‚              â”‚              â”‚ UPDATE         â”‚               â”‚
     â”‚              â”‚              â”‚ (æäº¤è®°å¿†)     â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 3. next_acting(GM, entities)                 â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(NEXT_ACTING)              â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚<â”€entity_nameâ”€â”¤                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(NEXT_ACTION_SPEC)         â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚<â”€action_specâ”€â”¤                â”‚               â”‚
     â”‚<â”€(entity, spec)              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 4. entity.act(action_spec)  â”‚                â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ PRE_ACT        â”‚               â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚              â”‚              â”‚ pre_act()      â”‚               â”‚
     â”‚              â”‚              â”‚ (Plan, Memory, â”‚               â”‚
     â”‚              â”‚              â”‚  SelfPerceptionç­‰)             â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€contextsâ”€â”€â”€â”€â”¤               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ get_action_attempt()           â”‚
     â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚              â”‚<â”€â”€â”€actionâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ POST_ACT       â”‚               â”‚
     â”‚              â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
     â”‚              â”‚              â”‚ UPDATE         â”‚               â”‚
     â”‚              â”‚              â”‚ (æäº¤è®°å¿†)     â”‚               â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€actionâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 5. resolve(GM, action)      â”‚                â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(RESOLVE) â”‚                â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚ ThoughtChains  â”‚               â”‚
     â”‚              â”‚              â”‚ (attemptâ†’result)               â”‚
     â”‚              â”‚              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚              â”‚<â”€â”€eventâ”€â”€â”€â”€â”€â”€â”¤<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚<â”€â”€eventâ”€â”€â”€â”€â”€â”€â”¤              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 6. terminate(GM)            â”‚                â”‚               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚                â”‚               â”‚
     â”‚              â”‚ act(TERMINATE)                â”‚               â”‚
     â”‚              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                â”‚               â”‚
     â”‚              â”‚<â”€â”€"Yes/No"â”€â”€â”€â”¤                â”‚               â”‚
     â”‚<â”€â”€boolâ”€â”€â”€â”€â”€â”€â”€â”¤              â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚
     â”‚ 7. å¾ªç¯ç»§ç»­æˆ–ç»“æŸ            â”‚                â”‚               â”‚
     â”‚              â”‚              â”‚                â”‚               â”‚</pre>
    </div>

    <h2 id="data-flow">4. æ•°æ®æµæ¦‚è§ˆ</h2>

    <div class="diagram">
        <h3>4.1 æ ¸å¿ƒæ•°æ®æµå‘</h3>

        <div style="background: linear-gradient(to bottom, #ecf0f1, white); padding: 25px; border-radius: 8px;">
            <h4>1. Engine â†’ GM â†’ Engine</h4>
            <div style="margin: 20px 0;">
                <div class="dataflow-box" style="background: #3498db; color: white;">Engine</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">ActionSpec<br/>(OutputType)</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #e74c3c; color: white;">GM</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">å†³ç­–ç»“æœ<br/>(è§‚å¯Ÿ/å®ä½“/äº‹ä»¶)</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #3498db; color: white;">Engine</div>
            </div>
            <div class="code-ref">ğŸ“ concordia/environment/engines/sequential.py:193-271</div>

            <h4>2. Engine â†’ Entity â†’ Engine</h4>
            <div style="margin: 20px 0;">
                <div class="dataflow-box" style="background: #3498db; color: white;">Engine</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">observation<br/>æˆ– ActionSpec</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #9b59b6; color: white;">Entity</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">action_attempt</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #3498db; color: white;">Engine</div>
            </div>

            <h4>3. Entity â†’ Components â†’ Entityï¼ˆact æµç¨‹ï¼‰</h4>
            <div style="margin: 20px 0;">
                <div class="dataflow-box" style="background: #9b59b6; color: white;">Entity</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">ActionSpec</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #1abc9c; color: white;">ContextComponents</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">contexts å­—å…¸</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #f39c12; color: white;">ActingComponent</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #9b59b6; color: white;">Entity</div>
            </div>
            <div class="code-ref">ğŸ“ concordia/agents/entity_agent.py:194-247</div>

            <h4>4. Components â†” Memory</h4>
            <div style="margin: 20px 0;">
                <div class="dataflow-box" style="background: #1abc9c; color: white;">Components</div>
                <span class="flow-arrow">â‡„</span>
                <div class="dataflow-box" style="background: #34495e; color: white;">Memory</div>
                <span class="flow-arrow">â‡„</span>
                <div class="dataflow-box">AssociativeMemoryBank<br/>(å‘é‡åµŒå…¥)</div>
            </div>
            <ul>
                <li><strong>å†™å…¥ï¼š</strong>Memory.add(text, tags) â†’ ç¼“å­˜ â†’ UPDATE é˜¶æ®µæäº¤</li>
                <li><strong>è¯»å–ï¼š</strong>Memory.retrieve_recent() æˆ– retrieve_associative()</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/components/agent/memory.py:32-426</div>

            <h4>5. Components â†” LLMï¼ˆé€šè¿‡ InteractiveDocumentï¼‰</h4>
            <div style="margin: 20px 0;">
                <div class="dataflow-box" style="background: #1abc9c; color: white;">Component</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">InteractiveDocument</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">prompt æ–‡æœ¬</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #e67e22; color: white;">LLM</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box">response</div>
                <span class="flow-arrow">â†’</span>
                <div class="dataflow-box" style="background: #1abc9c; color: white;">Component</div>
            </div>
            <div class="code-ref">ğŸ“ concordia/document/interactive_document.py:48-351</div>
        </div>
    </div>

    <div class="diagram">
        <h3>4.2 æ•°æ®ç±»å‹è¯¦è§£</h3>

        <table>
            <thead>
                <tr>
                    <th>æ•°æ®ç±»å‹</th>
                    <th>ç»“æ„</th>
                    <th>ç”¨é€”</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>ActionSpec</strong></td>
                    <td>
                        <pre style="margin: 5px 0; padding: 8px; background: #2c3e50; font-size: 0.85em;">
{
  call_to_action: str,
  output_type: OutputType,
  options: Sequence[str],
  tag: str | None
}</pre>
                    </td>
                    <td>æŒ‡å®šå®ä½“æˆ– GM éœ€è¦æ‰§è¡Œçš„è¡ŒåŠ¨ç±»å‹</td>
                    <td>ğŸ“ entity.py:73-141</td>
                </tr>
                <tr>
                    <td><strong>OutputType</strong></td>
                    <td>
                        <pre style="margin: 5px 0; padding: 8px; background: #2c3e50; font-size: 0.85em;">
FREE, CHOICE, FLOAT,
MAKE_OBSERVATION,
NEXT_ACTING,
NEXT_ACTION_SPEC,
RESOLVE, TERMINATE,
NEXT_GAME_MASTER</pre>
                    </td>
                    <td>ActionSpec çš„è¾“å‡ºç±»å‹æšä¸¾</td>
                    <td>ğŸ“ entity.py:25-41</td>
                </tr>
                <tr>
                    <td><strong>ComponentContextMapping</strong></td>
                    <td>
                        <pre style="margin: 5px 0; padding: 8px; background: #2c3e50; font-size: 0.85em;">
Mapping[str, str]
# {component_name: context}</pre>
                    </td>
                    <td>æ‰€æœ‰ ContextComponent çš„è¾“å‡ºèšåˆ</td>
                    <td>ğŸ“ entity_component.py:189</td>
                </tr>
                <tr>
                    <td><strong>Memory Item</strong></td>
                    <td>
                        <pre style="margin: 5px 0; padding: 8px; background: #2c3e50; font-size: 0.85em;">
{
  text: str,
  embedding: np.ndarray,
  timestamp: datetime,
  importance: float,
  metadata: dict
}</pre>
                    </td>
                    <td>AssociativeMemoryBank ä¸­çš„è®°å¿†æ¡ç›®</td>
                    <td>ğŸ“ basic_associative_memory.py:50-548</td>
                </tr>
                <tr>
                    <td><strong>Observation</strong></td>
                    <td>
                        <pre style="margin: 5px 0; padding: 8px; background: #2c3e50; font-size: 0.85em;">
str
# å¸¦ [observation] æ ‡ç­¾</pre>
                    </td>
                    <td>å®ä½“æ¥æ”¶çš„è§‚å¯Ÿæ–‡æœ¬</td>
                    <td>ğŸ“ observation.py:26</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="diagram">
        <h3>4.3 ä¸Šä¸‹æ–‡èšåˆæœºåˆ¶</h3>
        <div class="code-ref">ğŸ“ concordia/components/agent/concat_act_component.py:84-97</div>

        <p><strong>ConcatActComponent å¦‚ä½•èšåˆä¸Šä¸‹æ–‡ï¼š</strong></p>

        <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px;">
def _context_for_action(self, contexts: ComponentContextMapping) -> str:
    if self._component_order is None:
        # æŒ‰ç»„ä»¶å­—å…¸é¡ºåºè¿æ¥
        return '\n'.join(context for context in contexts.values() if context)
    else:
        # æŒ‰æŒ‡å®šé¡ºåºè¿æ¥
        order = self._component_order + tuple(sorted(
            set(contexts.keys()) - set(self._component_order)))
        return '\n'.join(contexts[name] for name in order if contexts[name])</pre>

        <p><strong>ä¸Šä¸‹æ–‡ç¤ºä¾‹ï¼ˆæ‹¼æ¥åçš„ promptï¼‰ï¼š</strong></p>
        <pre style="background: white; color: #2c3e50; border: 2px solid #95a5a6; padding: 15px;">
Role playing instructions:
The instructions for how to play the role of Alice are as follows...

Plan:
Alice's step-by-step plan is to first greet Bob, then discuss the weather...

Self Perception:
Alice is a friendly and outgoing person who enjoys social interactions...

Observations (ordered from oldest to latest):
[observation] Alice sees Bob walking towards her.
[observation] The weather is sunny and warm.

---

Exercise: What would Alice do next?</pre>
    </div>

    <h2 id="component-details">5. ç»„ä»¶ç³»ç»Ÿè¯¦è§£</h2>

    <div class="diagram">
        <h3>5.1 ContextComponent å·¥ä½œåŸç†</h3>

        <p><strong>ContextComponent çš„ç”Ÿå‘½å‘¨æœŸï¼š</strong></p>

        <table>
            <thead>
                <tr>
                    <th>Phase</th>
                    <th>è°ƒç”¨æ–¹æ³•</th>
                    <th>ä½œç”¨</th>
                    <th>è¿”å›å€¼</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="phase-preact">PRE_ACT</td>
                    <td><span class="class-name">pre_act(action_spec)</span></td>
                    <td>ç”Ÿæˆä¸Šä¸‹æ–‡ä¿¡æ¯</td>
                    <td>context string</td>
                </tr>
                <tr>
                    <td class="phase-postact">POST_ACT</td>
                    <td><span class="class-name">post_act(action_attempt)</span></td>
                    <td>å¤„ç†è¡ŒåŠ¨ç»“æœ</td>
                    <td>empty string</td>
                </tr>
                <tr>
                    <td class="phase-preobs">PRE_OBSERVE</td>
                    <td><span class="class-name">pre_observe(observation)</span></td>
                    <td>æ¥æ”¶è§‚å¯Ÿ</td>
                    <td>empty string</td>
                </tr>
                <tr>
                    <td class="phase-postobs">POST_OBSERVE</td>
                    <td><span class="class-name">post_observe()</span></td>
                    <td>å¤„ç†è§‚å¯Ÿ</td>
                    <td>empty string</td>
                </tr>
                <tr>
                    <td class="phase-update">UPDATE</td>
                    <td><span class="class-name">update()</span></td>
                    <td>æäº¤æ›´æ”¹ï¼Œé‡ç½®çŠ¶æ€</td>
                    <td>None</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="diagram">
        <h3>5.2 ActionSpecIgnored ç¼“å­˜æœºåˆ¶</h3>
        <div class="code-ref">ğŸ“ concordia/components/agent/action_spec_ignored.py:26-101</div>

        <p><strong>è®¾è®¡ç›®çš„ï¼š</strong>å…è®¸å…¶ä»–ç»„ä»¶åœ¨ PRE_ACT é˜¶æ®µå®‰å…¨åœ°è®¿é—®è¯¥ç»„ä»¶çš„ pre_act å€¼</p>

        <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px;">
# ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è®¡ç®—å¹¶ç¼“å­˜
def get_pre_act_value(self) -> str:
    if self.get_entity().get_phase() != Phase.PRE_ACT:
        raise ValueError("åªèƒ½åœ¨ PRE_ACT é˜¶æ®µè®¿é—®")

    with self._lock:
        if self._pre_act_value is None:
            self._pre_act_value = self._make_pre_act_value()  # è°ƒç”¨å­ç±»å®ç°
        return self._pre_act_value

# UPDATE é˜¶æ®µæ¸…é™¤ç¼“å­˜
def update(self) -> None:
    with self._lock:
        self._pre_act_value = None</pre>

        <p><strong>è·¨ç»„ä»¶è®¿é—®ç¤ºä¾‹ï¼š</strong></p>
        <pre style="background: white; color: #2c3e50; border: 2px solid #95a5a6; padding: 15px;">
# Plan ç»„ä»¶åœ¨ PRE_ACT é˜¶æ®µè®¿é—®å…¶ä»–ç»„ä»¶
component_states = '\n'.join([
    self._component_pre_act_display(key) for key in self._components
])

# å®‰å…¨è®¿é—®ï¼Œå› ä¸ºéƒ½åœ¨ PRE_ACT é˜¶æ®µ
def _component_pre_act_display(self, key: str) -> str:
    return (
        f'{self.get_component_pre_act_label(key)}:\n'
        f'{self.get_named_component_pre_act_value(key)}'  # è°ƒç”¨å…¶ä»–ç»„ä»¶çš„ get_pre_act_value()
    )</pre>
    </div>

    <div class="diagram">
        <h3>5.3 Memory æäº¤æœºåˆ¶</h3>
        <div class="code-ref">ğŸ“ concordia/components/agent/memory.py:32-426</div>

        <p><strong>ä¸¤é˜¶æ®µæäº¤æ¨¡å¼ï¼š</strong></p>

        <div class="sequence-step">
            <span class="sequence-number">1</span>
            <strong>ç¼“å­˜é˜¶æ®µï¼š</strong>åœ¨ PRE_OBSERVE æˆ–å…¶ä»–é˜¶æ®µè°ƒç”¨ <span class="class-name">Memory.add(text, tags)</span>
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
def add(self, text: str, tags: Collection[str] = ()) -> None:
    # æ·»åŠ åˆ°ç¼“å­˜åˆ—è¡¨
    self._buffer.append({
        'text': text,
        'tags': tags,
        'timestamp': self._clock_now()
    })</pre>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">2</span>
            <strong>æäº¤é˜¶æ®µï¼š</strong>åœ¨ UPDATE é˜¶æ®µè°ƒç”¨ <span class="class-name">Memory.update()</span>
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
def update(self) -> None:
    # æ‰¹é‡æäº¤æ‰€æœ‰ç¼“å­˜çš„è®°å¿†åˆ° AssociativeMemoryBank
    for item in self._buffer:
        self._memory.add(
            text=item['text'],
            metadata={'tags': item['tags']},
            timestamp=item['timestamp']
        )
    self._buffer.clear()  # æ¸…ç©ºç¼“å­˜</pre>
        </div>

        <div class="note">
            <strong>ä¸ºä»€ä¹ˆéœ€è¦ç¼“å­˜ï¼Ÿ</strong>é¿å…åœ¨ Phase è½¬æ¢è¿‡ç¨‹ä¸­ç«‹å³ä¿®æ”¹å…±äº«çŠ¶æ€ï¼Œç¡®ä¿æ‰€æœ‰ç»„ä»¶åœ¨åŒä¸€ Phase ä¸‹çœ‹åˆ°ä¸€è‡´çš„æ•°æ®ã€‚
        </div>
    </div>

    <div class="diagram">
        <h3>5.4 GM ç»„ä»¶çš„ç‰¹æ®Šæ€§</h3>

        <p><strong>GM ç»„ä»¶å“åº”ä¸åŒçš„ OutputTypeï¼š</strong></p>

        <table>
            <thead>
                <tr>
                    <th>ç»„ä»¶åç§°</th>
                    <th>å“åº”çš„ OutputType</th>
                    <th>è¿”å›å†…å®¹</th>
                    <th>ä»£ç ä½ç½®</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>MakeObservation</td>
                    <td>MAKE_OBSERVATION</td>
                    <td>è§‚å¯Ÿæ–‡æœ¬ï¼ˆä»äº‹ä»¶é˜Ÿåˆ—ç”Ÿæˆï¼‰</td>
                    <td>ğŸ“ make_observation.py:79-138</td>
                </tr>
                <tr>
                    <td>NextActing ç³»åˆ—</td>
                    <td>NEXT_ACTING</td>
                    <td>å®ä½“åç§°</td>
                    <td>ğŸ“ next_acting.py:72-457</td>
                </tr>
                <tr>
                    <td>NextActing ç³»åˆ—</td>
                    <td>NEXT_ACTION_SPEC</td>
                    <td>ActionSpec å­—ç¬¦ä¸²<br/>æ ¼å¼: "prompt: ...;;type: ...;;options: ..."</td>
                    <td>ğŸ“ next_acting.py:72-457</td>
                </tr>
                <tr>
                    <td>EventResolution</td>
                    <td>RESOLVE</td>
                    <td>è§£æåçš„äº‹ä»¶æ–‡æœ¬</td>
                    <td>ğŸ“ event_resolution.py:83-183</td>
                </tr>
                <tr>
                    <td>Terminate</td>
                    <td>TERMINATE</td>
                    <td>"Yes" æˆ– "No"</td>
                    <td>ğŸ“ terminate.py:45-54</td>
                </tr>
                <tr>
                    <td>NextGameMaster</td>
                    <td>NEXT_GAME_MASTER</td>
                    <td>GM åç§°</td>
                    <td>ğŸ“ next_game_master.py:96-121</td>
                </tr>
            </tbody>
        </table>

        <p><strong>GM ç»„ä»¶åˆ¤æ–­ OutputType çš„æ¨¡å¼ï¼š</strong></p>
        <pre style="background: #2c3e50; color: #ecf0f1; padding: 15px;">
def pre_act(self, action_spec: ActionSpec) -> str:
    if action_spec.output_type == OutputType.MAKE_OBSERVATION:
        # ç”Ÿæˆè§‚å¯Ÿ
        return self._generate_observation()
    return ''  # ä¸å“åº”å…¶ä»–ç±»å‹</pre>
    </div>

    <div class="diagram">
        <h3>5.5 ThoughtChains äº‹ä»¶è§£ææµç¨‹</h3>
        <div class="code-ref">ğŸ“ concordia/thought_chains/thought_chains.py (å®Œæ•´æ–‡ä»¶)</div>

        <p><strong>EventResolution ä½¿ç”¨ ThoughtChains çš„æ­¥éª¤ï¼š</strong></p>

        <div class="sequence-step">
            <span class="sequence-number">1</span>
            <strong>attempt_to_resultï¼š</strong>å°†å°è¯•è½¬æ¢ä¸ºç»“æœ
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
prompt.statement(f"Attempt: {attempt}")
prompt.statement(f"Current state: {state}")
result = prompt.open_question(
    "What would be the result of this attempt?",
    max_tokens=500
)</pre>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">2</span>
            <strong>determine_success_and_whyï¼š</strong>åˆ¤æ–­æˆåŠŸä¸å¦åŠåŸå› 
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
success = prompt.yes_no_question(
    f"Was the attempt '{attempt}' successful in achieving '{result}'?"
)
why = prompt.open_question(
    "Why or why not?",
    max_tokens=300
)</pre>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">3</span>
            <strong>result_to_effect_on_stateï¼š</strong>è½¬æ¢ä¸ºçŠ¶æ€æ•ˆæœ
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
effect = prompt.open_question(
    "How does this result change the state of the world?",
    max_tokens=500
)</pre>
        </div>

        <div class="sequence-step">
            <span class="sequence-number">4</span>
            <strong>ç»„åˆæœ€ç»ˆäº‹ä»¶ï¼š</strong>
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 10px; margin: 10px 0;">
final_event = f"{result}. {why}. {effect}"</pre>
        </div>
    </div>

    <h2>6. æ€»ç»“ä¸å…³é”®è®¾è®¡æ¨¡å¼</h2>

    <div class="diagram">
        <h3>6.1 æ ¸å¿ƒè®¾è®¡æ¨¡å¼</h3>

        <div class="component-box">
            <div class="component-title">1. Entity-Component æ¶æ„ï¼ˆç»„åˆä¼˜äºç»§æ‰¿ï¼‰</div>
            <ul>
                <li>Entity ä¸ç›´æ¥å®ç°å¤æ‚é€»è¾‘ï¼Œè€Œæ˜¯å§”æ‰˜ç»™ Components</li>
                <li>Components å¯ä»¥çµæ´»ç»„åˆï¼Œåˆ›å»ºä¸åŒè¡Œä¸ºçš„ Entity</li>
                <li>æ–°åŠŸèƒ½é€šè¿‡æ·»åŠ æ–° Component å®ç°ï¼Œæ— éœ€ä¿®æ”¹ Entity</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/agents/entity_agent.py:40-399</div>
        </div>

        <div class="component-box">
            <div class="component-title">2. Phase çŠ¶æ€æœºæ¨¡å¼</div>
            <ul>
                <li>ç¡®ä¿ç»„ä»¶åœ¨æ­£ç¡®çš„é˜¶æ®µæ‰§è¡Œæ­£ç¡®çš„æ“ä½œ</li>
                <li>æä¾›çº¿ç¨‹å®‰å…¨çš„è·¨ç»„ä»¶æ•°æ®è®¿é—®</li>
                <li>æ¸…æ™°çš„çŠ¶æ€è½¬æ¢æµç¨‹ï¼Œæ˜“äºç†è§£å’Œè°ƒè¯•</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/typing/entity_component.py:28-46</div>
        </div>

        <div class="component-box">
            <div class="component-title">3. ç­–ç•¥æ¨¡å¼ï¼ˆActingComponentï¼‰</div>
            <ul>
                <li>ActingComponent æ¥å£ç»Ÿä¸€ï¼Œå®ç°å¯æ›¿æ¢</li>
                <li>ConcatActComponent æ˜¯æ ‡å‡†å®ç°ï¼Œå¯ä»¥åˆ›å»ºå…¶ä»–ç­–ç•¥</li>
                <li>ä¸åŒ Entity å¯ä»¥ä½¿ç”¨ä¸åŒçš„ ActingComponent</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/components/agent/concat_act_component.py:26-181</div>
        </div>

        <div class="component-box">
            <div class="component-title">4. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆMemory ç³»ç»Ÿï¼‰</div>
            <ul>
                <li>Components é€šè¿‡ Memory é—´æ¥é€šä¿¡</li>
                <li>è§‚å¯Ÿå’Œè¡ŒåŠ¨è®°å½•åˆ° Memoryï¼Œå…¶ä»–ç»„ä»¶å¯ä»¥æ£€ç´¢</li>
                <li>è§£è€¦ç»„ä»¶ä¹‹é—´çš„ç›´æ¥ä¾èµ–</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/components/agent/memory.py:32-426</div>
        </div>

        <div class="component-box">
            <div class="component-title">5. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆActionSpecIgnoredï¼‰</div>
            <ul>
                <li>åŸºç±»å®šä¹‰ç®—æ³•éª¨æ¶ï¼ˆç¼“å­˜ã€Phase æ£€æŸ¥ï¼‰</li>
                <li>å­ç±»å®ç°ç‰¹å®šæ­¥éª¤ï¼ˆ_make_pre_act_valueï¼‰</li>
                <li>å‡å°‘é‡å¤ä»£ç ï¼Œç»Ÿä¸€ç»„ä»¶è¡Œä¸º</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/components/agent/action_spec_ignored.py:26-101</div>
        </div>

        <div class="component-box">
            <div class="component-title">6. è´£ä»»é“¾æ¨¡å¼ï¼ˆThoughtChainsï¼‰</div>
            <ul>
                <li>äº‹ä»¶è§£æåˆ†ä¸ºå¤šä¸ªæ­¥éª¤ï¼Œæ¯æ­¥ä¸“æ³¨ä¸€ä¸ªä»»åŠ¡</li>
                <li>æ­¥éª¤å¯ä»¥ç»„åˆå’Œé‡ç”¨</li>
                <li>ä¾¿äºæ‰©å±•æ–°çš„è§£æé€»è¾‘</li>
            </ul>
            <div class="code-ref">ğŸ“ concordia/thought_chains/thought_chains.py</div>
        </div>
    </div>

    <div class="diagram">
        <h3>6.2 æ¶æ„ä¼˜åŠ¿</h3>

        <table>
            <thead>
                <tr>
                    <th>ä¼˜åŠ¿</th>
                    <th>å®ç°æ–¹å¼</th>
                    <th>æ•ˆæœ</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>å¯æ‰©å±•æ€§</strong></td>
                    <td>Component ç³»ç»Ÿ</td>
                    <td>æ·»åŠ æ–° Component æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç </td>
                </tr>
                <tr>
                    <td><strong>å¯å¤ç”¨æ€§</strong></td>
                    <td>ç»„ä»¶å¯åœ¨ä¸åŒ Entity é—´å…±äº«</td>
                    <td>å‡å°‘é‡å¤ä»£ç ï¼Œæé«˜å¼€å‘æ•ˆç‡</td>
                </tr>
                <tr>
                    <td><strong>å¯æµ‹è¯•æ€§</strong></td>
                    <td>ç»„ä»¶ç‹¬ç«‹ï¼ŒèŒè´£å•ä¸€</td>
                    <td>æ˜“äºå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•</td>
                </tr>
                <tr>
                    <td><strong>å¹¶å‘å®‰å…¨</strong></td>
                    <td>Phase çŠ¶æ€æœº + é”æœºåˆ¶</td>
                    <td>æ”¯æŒå¹¶è¡Œæ‰§è¡Œï¼Œé¿å…ç«æ€æ¡ä»¶</td>
                </tr>
                <tr>
                    <td><strong>çµæ´»æ€§</strong></td>
                    <td>LLM é©±åŠ¨çš„å†³ç­–</td>
                    <td>æ™ºèƒ½ä½“è¡Œä¸ºå¯åŠ¨æ€è°ƒæ•´</td>
                </tr>
                <tr>
                    <td><strong>å¯è§‚å¯Ÿæ€§</strong></td>
                    <td>ComponentWithLogging</td>
                    <td>å®Œæ•´çš„è°ƒè¯•å’Œåˆ†æèƒ½åŠ›</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="note" style="background: #e8f4f8; border-color: #3498db;">
        <strong>ğŸ¯ Concordia çš„æ ¸å¿ƒç†å¿µï¼š</strong>
        <p>é€šè¿‡ <strong>Entity-Component æ¶æ„</strong> + <strong>Phase çŠ¶æ€æœº</strong> + <strong>LLM é©±åŠ¨</strong>ï¼Œåˆ›å»ºä¸€ä¸ªçµæ´»ã€å¯æ‰©å±•ã€æ˜“äºç†è§£çš„ç¤¾ä¼šæ¨¡æ‹Ÿæ¡†æ¶ã€‚æ¯ä¸ªç»„ä»¶éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„"è®¤çŸ¥æ¨¡å—"ï¼Œå®ƒä»¬ååŒå·¥ä½œï¼Œå½¢æˆæ™ºèƒ½ä½“çš„å®Œæ•´è®¤çŸ¥å’Œè¡Œä¸ºèƒ½åŠ›ã€‚</p>
    </div>

    <hr style="margin: 40px 0; border: 2px solid #3498db;">

    <div style="text-align: center; color: #7f8c8d; margin-top: 40px;">
        <p><strong>æ–‡æ¡£ç”Ÿæˆæ—¶é—´ï¼š</strong>2025-11-10</p>
        <p><strong>åŸºäºæºç ç‰ˆæœ¬ï¼š</strong>Concordia Framework (concordia æ–‡ä»¶å¤¹å®Œæ•´æºç )</p>
        <p><strong>æ–‡æ¡£ä½œè€…ï¼š</strong>Claude Code (åŸºäºæºç åˆ†æè‡ªåŠ¨ç”Ÿæˆ)</p>
    </div>

</body>
</html>